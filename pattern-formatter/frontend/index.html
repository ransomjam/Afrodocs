<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfroDocs</title>
    <meta name="theme-color" content="#0D2F4A">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AfroDocs">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="logo/logo.png">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js for mobile PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">

    <!-- CDN fallback: try local /vendor/* copies if CDN resources time out -->
    <script>
    (function(){
        function loadScript(src, onload, onerror){
            var s = document.createElement('script');
            s.src = src;
            s.onload = onload || function(){};
            s.onerror = onerror || function(){};
            document.head.appendChild(s);
            return s;
        }
        function loadCSS(href){
            var l = document.createElement('link');
            l.rel = 'stylesheet';
            l.href = href;
            l.onerror = function(){ showResourceError(); };
            document.head.appendChild(l);
            return l;
        }
        function showResourceError(){
            if(document.getElementById('resource-error')) return;
            var el = document.createElement('div');
            el.id = 'resource-error';
            el.innerHTML = '<strong>Resources failed to load.</strong> The app could not load some external scripts (CDN blocked or offline).\n\nPlease ensure internet access or download the vendor files into <code>/vendor</code> and restart the app.';
            el.style.position = 'fixed';
            el.style.left = '12px';
            el.style.right = '12px';
            el.style.bottom = '12px';
            el.style.padding = '12px 16px';
            el.style.background = '#fff3cd';
            el.style.color = '#222';
            el.style.border = '1px solid #ffeeba';
            el.style.borderRadius = '6px';
            el.style.zIndex = 99999;
            el.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
            document.body.appendChild(el);
        }
        function tryLocalFallback(){
            // If ReactDOM didn't load from CDN, attempt local vendor copy
            if(typeof ReactDOM === 'undefined'){
                loadScript('/vendor/react-dom.development.js', function(){console.info('Loaded local react-dom')}, showResourceError);
            }
            // If Babel didn't load, attempt local vendor
            if(typeof Babel === 'undefined'){
                loadScript('/vendor/babel.min.js', function(){console.info('Loaded local babel')}, showResourceError);
            }
            // If lucide CSS not present (no link with 'lucide'), add local file
            if(!document.querySelector('link[href*="lucide"]')){
                loadCSS('/vendor/lucide.min.css');
            }
            // If fonts or tailwind fail to load, we can't easily polyfill here; show message after timeout
            setTimeout(function(){
                if(typeof ReactDOM === 'undefined' || typeof Babel === 'undefined'){
                    showResourceError();
                }
            }, 2500);
        }
        // Try fallback shortly after load in case CDNs time out
        window.addEventListener('load', tryLocalFallback);
    })();
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ocean: {
                            DEFAULT: '#1E5A8E',
                            dark: '#0D2F4A',
                        },
                        teal: {
                            DEFAULT: '#00B4A6',
                            light: '#7DD3C0',
                        },
                        amber: {
                            DEFAULT: '#F2A93B',
                        },
                        coral: {
                            DEFAULT: '#FF6B6B',
                        },
                        midnight: '#1A1F2E',
                        slate: '#4A5568',
                        mist: '#CBD5E0', // Lighter for better contrast
                        cloud: '#F7FAFC',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Poppins', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(0, 180, 166, 0.3)',
                        'glass': '0 4px 20px 0 rgba(0, 0, 0, 0.2)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(13, 47, 74, 0.3);
        }
        ::-webkit-scrollbar-thumb {
            background: #4A5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        /* Drag over effect */
        .drag-over {
            border-color: #00B4A6 !important;
            background-color: rgba(0, 180, 166, 0.1) !important;
            box-shadow: 0 0 20px rgba(0, 180, 166, 0.15);
        }
        
        /* Animation keyframes */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(0, 180, 166, 0.2); }
            50% { box-shadow: 0 0 25px rgba(0, 180, 166, 0.4); }
        }
        
        /* Animated stroke tracing around bolt outline */
        @keyframes trace-outline {
            /* animate dashoffset negatively so the visible dash moves along the path leftâ†’right */
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: -180; }
        }

        .lightning-loading {
            color: #00B4A6;
            font-size: 9rem; /* increased by 2x */
        }

        .lightning-loading svg {
            stroke: #00B4A6;
            stroke-width: 1.2;
            stroke-linecap: round;
            stroke-dasharray: 8 120; /* short lit segment, long gap */
            animation: trace-outline 0.6s linear infinite; /* slightly slower */
        }
        
        .processing-glow {
            animation: pulse-glow 2s infinite;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D2F4A;
            color: #E2E8F0;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.025em;
        }

        /* Glassmorphism utilities - Professional Grade */
        .glass-panel {
            background: rgba(13, 47, 74, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            color: #F7FAFC;
        }

        .glass-input:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: #00B4A6;
            box-shadow: 0 0 0 1px rgba(0, 180, 166, 0.3);
        }
        
        /* Form label helper */
        .form-label {
            color: #CBD5E0;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.375rem;
            display: block;
        }
        
        @media (min-width: 768px) {
            .form-label {
                font-size: 1rem;
            }
        }

        /* Document Preview Styles - Exact Replica */
        .document-preview-container {
            background-color: #525659;
            padding: 2rem;
            overflow: auto; /* Allow scrolling in both directions */
            max-height: 800px;
            border-radius: 0.75rem;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center; /* Center the page on large screens */
            align-items: flex-start;
        }

        /* Short informational note shown above previews */
        .document-preview-note {
            font-size: 0.95rem;
            color: #C6E7F2;
            margin: 0 0 0.5rem 0;
            line-height: 1.35;
        }
        @media (max-width: 640px) {
            .document-preview-note {
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
                font-size: 0.95rem;
            }
        }

        .document-page {
            background-color: white;
            color: black;
            /* Fixed A4 dimensions to ensure identical structure on all devices */
            width: 210mm; 
            min-height: 297mm;
            flex-shrink: 0; /* Prevent shrinking on mobile */
            margin: 0 auto;
            padding: 25.4mm; /* 1 inch margins */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-family: 'Times New Roman', Times, serif;
            font-size: 12pt;
            line-height: 1.5; /* Exact match to backend */
            text-align: justify;
            position: relative;
            box-sizing: border-box;
        }

        .document-page p {
            margin-bottom: 0;
            text-indent: 0; /* Backend uses first_line_indent for some, but 0 for others. Default to 0 and add class for indent */
        }
        
        .document-page .indent-para {
            text-indent: 0.5in;
        }

        .document-page h1 {
            font-size: 12pt;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            margin-top: 0;
            margin-bottom: 12pt;
            color: black;
        }

        .document-page h2, .document-page h3, .document-page h4 {
            font-size: 12pt;
            font-weight: bold;
            text-align: left;
            margin-top: 12pt;
            margin-bottom: 6pt;
            color: black;
        }

        .document-page .figure-caption {
            font-style: italic;
            text-align: center;
            margin-top: 6pt;
            margin-bottom: 12pt;
        }

        .document-page .table-caption {
            font-weight: bold;
            text-align: center;
            margin-bottom: 6pt;
        }

        .document-page table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 12pt;
            font-size: 12pt;
        }

        .document-page th, .document-page td {
            border: 1px solid black;
            padding: 4pt;
            vertical-align: top;
        }

        .document-page th {
            font-weight: bold;
            text-align: center;
        }

        .document-page .block-quote {
            margin-left: 0.5in;
            margin-right: 0.5in;
            font-style: italic;
            margin-top: 6pt;
            margin-bottom: 6pt;
        }

        .document-page .hanging-indent {
            padding-left: 0.5in;
            text-indent: -0.25in;
        }
        
        .document-page .glossary-indent {
            padding-left: 0.25in;
            text-indent: -0.25in;
        }

        .document-page .math-display {
            text-align: center;
            margin-top: 12pt;
            margin-bottom: 12pt;
        }

        .document-page .document-list {
            margin-left: 0;
            margin-right: 0;
            padding-left: 0.75rem;
            list-style-position: outside;
        }

        .document-page ol.document-list {
            padding-left: 1.5rem;
        }

        .document-page .document-list-item {
            padding-left: 0.0625rem;
        }

        .document-page ul.document-list li::marker {
            color: rgba(0, 0, 0, 0.48);
        }

        .lightning-flash-container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .lightning-bolt {
            color: #00B4A6;
            font-size: 12rem; /* increased by 2x */
        }

        .lightning-bolt svg {
            stroke: #00B4A6;
            stroke-width: 1.2;
            stroke-linecap: round;
            stroke-dasharray: 8 120;
            animation: trace-outline 0.6s linear infinite; /* slightly slower */
        }

        .tech-grid {
            background-image: 
                linear-gradient(rgba(0, 180, 166, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 180, 166, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* AI Assistant Styles - Full Page Mode */
        .ai-chat-container {
            background: transparent;
            border: none;
            border-radius: 0;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .ai-layout-container {
            flex: 1;
            display: flex;
            height: 100%;
        }

        .ai-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .ai-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ai-restructure-bar {
            padding: 0.75rem 1rem 0;
            display: flex;
            justify-content: center;
        }

        .ai-restructure-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1.25rem;
            background: rgba(0, 180, 166, 0.15);
            border: 1px solid rgba(0, 180, 166, 0.4);
            color: #00B4A6;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .ai-restructure-btn:hover {
            background: rgba(0, 180, 166, 0.25);
            color: #E2E8F0;
        }

        .ai-restructure-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 1rem;
        }

        .ai-restructure-panel {
            width: 100%;
            max-width: 900px;
            background: #0a1929;
            border: 1px solid rgba(0, 180, 166, 0.3);
            border-radius: 1rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .ai-restructure-textarea {
            width: 100%;
            min-height: 180px;
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: #E2E8F0;
            font-size: 0.875rem;
            resize: vertical;
            outline: none;
        }

        .ai-restructure-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .ai-restructure-output {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.04);
            color: #E2E8F0;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 240px;
            overflow-y: auto;
        }

        .ai-message {
            padding: 0.875rem 1rem;
            border-radius: 1rem;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.35;
            text-align: left;
        }

        .ai-message-user {
            background: linear-gradient(135deg, #1E5A8E, #00B4A6);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-message-assistant {
            background: rgba(255, 255, 255, 0.1);
            color: #E2E8F0;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-message-comment {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
            opacity: 0.85;
            max-width: 70%;
        }

        .ai-message-assistant pre {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            padding: 0.75rem;
            overflow-x: auto;
            margin: 0.5rem 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        .ai-message-assistant code {
            background: rgba(0, 0, 0, 0.2);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }

        .ai-message-assistant pre code {
            background: transparent;
            padding: 0;
        }

        .ai-message-assistant ul, .ai-message-assistant ol {
            margin: 0.2rem 0;
            padding-left: 1.05rem;
            line-height: 1.35;
        }

        /* Responsive table wrapper for AI-generated tables */
        .ai-table-wrapper {
            overflow-x: auto;
            width: 100%;
            margin: 0.5rem 0;
        }

        .ai-message-assistant table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.02);
        }

        .ai-message-assistant th,
        .ai-message-assistant td {
            border: 1px solid rgba(255,255,255,0.06);
            padding: 0.375rem 0.5rem;
            text-align: left;
            vertical-align: top;
        }

        .ai-message-assistant li {
            margin: 0.12rem 0;
        }

        .ai-message-assistant h1, .ai-message-assistant h2, .ai-message-assistant h3, 
        .ai-message-assistant h4, .ai-message-assistant h5, .ai-message-assistant h6 {
            color: #00B4A6; /* topics in green */
            margin: 0 0 0.35rem 0;
            font-weight: 700;
            display: block;
            line-height: 1.35;
        }

        .ai-message-assistant h1 { font-size: 1.25rem; }
        .ai-message-assistant h2 { font-size: 1.125rem; }
        .ai-message-assistant h3 { font-size: 1rem; }

        .ai-message-assistant p {
            margin: 0;
            line-height: 1.35;
            color: white; /* body in white */
        }

        .ai-message-assistant p + p {
            margin-top: 0;
        }

        .ai-message-assistant strong {
            color: #00B4A6;
        }

        .ai-message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-action-button {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            color: #CBD5E0;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-action-button:hover {
            background: rgba(0, 180, 166, 0.2);
            border-color: rgba(0, 180, 166, 0.4);
            color: #00B4A6;
        }

        .ai-action-button.copied {
            background: rgba(0, 180, 166, 0.3);
            border-color: rgba(0, 180, 166, 0.5);
            color: #00B4A6;
        }

        .ai-action-button-format {
            background: linear-gradient(135deg, rgba(0, 180, 166, 0.15), rgba(30, 90, 142, 0.15));
            border-color: rgba(0, 180, 166, 0.3);
            color: #00B4A6;
        }

        .ai-action-button-format:hover {
            background: linear-gradient(135deg, rgba(0, 180, 166, 0.3), rgba(30, 90, 142, 0.3));
            border-color: rgba(0, 180, 166, 0.5);
            color: white;
        }

        .ai-input-container {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            align-items: flex-end;
        }

        .ai-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            color: #F7FAFC;
            font-size: 0.9375rem;
            outline: none;
            transition: all 0.2s ease;
            min-height: 44px;
            max-height: 200px;
            resize: none;
            overflow-y: auto;
            line-height: 1.5;
            font-family: inherit;
        }

        .ai-input:focus {
            border-color: #00B4A6;
            box-shadow: 0 0 0 2px rgba(0, 180, 166, 0.2);
        }

        .ai-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .ai-send-button {
            background: linear-gradient(135deg, #00B4A6, #1E5A8E);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            min-width: 3rem;
        }

        .ai-send-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 180, 166, 0.3);
        }

        .ai-send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-thinking-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #00B4A6;
            font-size: 0.875rem;
            padding: 0.5rem 0;
        }

        .ai-thinking-dots {
            display: flex;
            gap: 0.25rem;
        }

        .ai-thinking-dots span {
            width: 0.5rem;
            height: 0.5rem;
            background: #00B4A6;
            border-radius: 50%;
            animation: ai-bounce 1.4s infinite ease-in-out both;
        }

        .ai-thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .ai-thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        .ai-thinking-dots span:nth-child(3) { animation-delay: 0; }

        @keyframes ai-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .ai-welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            min-height: 300px;
        }

        .ai-welcome-icon {
            width: 4rem;
            height: 4rem;
            background: linear-gradient(135deg, #00B4A6, #1E5A8E);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 180, 166, 0.3);
        }

        .ai-suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .ai-suggestion-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #CBD5E0;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-suggestion-chip:hover {
            background: rgba(0, 180, 166, 0.2);
            border-color: rgba(0, 180, 166, 0.3);
            color: white;
        }

        .ai-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-header-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .ai-subtitle {
            font-size: 0.875rem;
            font-weight: 500;
            color: #C6E7F2;
            opacity: 0.95;
        }

        .ai-header-icon {
            width: 2rem;
            height: 2rem;
            background: linear-gradient(135deg, #00B4A6, #1E5A8E);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-clear-button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #CBD5E0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-clear-button:hover {
            background: rgba(255, 107, 107, 0.2);
            color: #FF6B6B;
        }

        .ai-toggle-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(0, 180, 166, 0.2), rgba(30, 90, 142, 0.2));
            border: 1px solid rgba(0, 180, 166, 0.3);
            border-radius: 0.75rem;
            color: #00B4A6;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            justify-content: center;
        }

        .ai-toggle-button:hover {
            background: linear-gradient(135deg, rgba(0, 180, 166, 0.3), rgba(30, 90, 142, 0.3));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 180, 166, 0.2);
        }

        /* Chat History Sidebar Styles */
        .ai-layout-container {
            display: flex;
            height: 100%;
            min-height: 500px;
        }

        .ai-sidebar {
            width: 220px;
            background: linear-gradient(180deg, #0a1929 0%, #0d2137 100%);
            border-right: 1px solid rgba(0, 180, 166, 0.2);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s ease, transform 0.2s ease;
            overflow: hidden;
        }

        .ai-sidebar:not(.open) {
            width: 0;
            border-right: none;
        }

        .ai-sidebar:not(.open) .ai-sidebar-header,
        .ai-sidebar:not(.open) .ai-chat-list {
            display: none;
        }

        .ai-sidebar-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0, 180, 166, 0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
        }

        .ai-sidebar-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #CBD5E0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ai-new-chat-btn {
            background: rgba(0, 180, 166, 0.2);
            border: 1px solid rgba(0, 180, 166, 0.3);
            border-radius: 0.375rem;
            padding: 0.375rem 0.5rem;
            color: #00B4A6;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .ai-new-chat-btn:hover {
            background: rgba(0, 180, 166, 0.3);
        }

        .ai-chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .ai-chat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.625rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 0.25rem;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
        }

        .ai-chat-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .ai-chat-item.active {
            background: rgba(0, 180, 166, 0.15);
            border: 1px solid rgba(0, 180, 166, 0.3);
        }

        .ai-chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .ai-chat-item-title {
            font-size: 0.8125rem;
            color: #E2E8F0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ai-chat-item-date {
            font-size: 0.6875rem;
            color: #718096;
            margin-top: 0.125rem;
        }

        .ai-chat-item-delete {
            background: transparent;
            border: none;
            color: #718096;
            padding: 0.25rem;
            border-radius: 0.25rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.15s ease;
        }

        .ai-chat-item:hover .ai-chat-item-delete {
            opacity: 1;
        }

        .ai-chat-item-delete:hover {
            color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
        }

        .ai-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .ai-sidebar-toggle {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: #CBD5E0;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .ai-sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 640px) {
            .ai-sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 70px; /* End above the input box */
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.2s ease;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5);
            }

            .ai-sidebar.open {
                transform: translateX(0);
            }

            .ai-sidebar-toggle {
                display: flex;
            }

            .ai-sidebar-overlay {
                display: none;
                position: absolute;
                inset: 0;
                bottom: 70px;
                background: rgba(0, 0, 0, 0.5);
                z-index: 40;
            }

            .ai-sidebar-overlay.open {
                display: block;
            }
        }

        /* ============================================
           UNIFIED APP LAYOUT - ChatGPT Style
           ============================================ */
        
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #0D2F4A 0%, #0F385C 50%, #1A1F2E 100%);
        }

        /* Global Sidebar */
        .app-sidebar {
            width: 260px;
            background: linear-gradient(180deg, #0a1929 0%, #0d2137 100%);
            border-right: 1px solid rgba(0, 180, 166, 0.15);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 100;
        }

        .app-sidebar.collapsed {
            width: 64px;
        }

        .app-sidebar.collapsed .app-sidebar-title,
        .app-sidebar.collapsed .app-sidebar-subtitle,
        .app-sidebar.collapsed .app-nav-section-title,
        .app-sidebar.collapsed .app-nav-item > span:last-child,
        .app-sidebar.collapsed .app-user-info,
        .app-sidebar.collapsed .app-user-button > svg:last-child,
        .app-sidebar.collapsed .sidebar-collapse-text,
        .app-sidebar.collapsed .app-sidebar-header > div:not(.app-sidebar-logo):not(:last-child),
        .app-sidebar.collapsed .app-sidebar-header > button,
        .app-sidebar.collapsed .app-sidebar-actions {
            display: none;
        }

        .app-sidebar.collapsed .app-sidebar-header {
            justify-content: center;
            padding: 1rem 0.5rem;
        }

        .app-sidebar.collapsed .app-nav-item {
            justify-content: center;
            padding: 0.75rem;
        }

        .app-sidebar.collapsed .app-user-button {
            justify-content: center;
            padding: 0.75rem;
        }

        .app-sidebar.collapsed .app-nav-item-icon {
            margin: 0;
        }

        .app-sidebar.collapsed .app-nav-section {
            padding: 0 0.25rem;
        }

        .app-sidebar-header {
            padding: 0.5rem 0.6rem 0.6rem 0.6rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            gap: 0.18rem; /* tighten gap so text is closer to logo */
        }

        .app-sidebar-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .app-install-button {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.75rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: #E7FFFB;
            border: 1px solid rgba(0, 180, 166, 0.55);
            border-radius: 0.6rem;
            background: linear-gradient(135deg, rgba(0, 180, 166, 0.2), rgba(13, 47, 74, 0.85));
            box-shadow: 0 4px 12px rgba(0, 180, 166, 0.15);
            transition: all 0.2s ease;
        }

        .app-install-button:hover {
            background: linear-gradient(135deg, rgba(0, 180, 166, 0.3), rgba(13, 47, 74, 0.95));
            border-color: rgba(0, 180, 166, 0.75);
            color: #FFFFFF;
            transform: translateY(-1px);
        }

        .app-install-button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .app-sidebar-logo {
            width: 104px;
            height: 104px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            margin-left: -4px; /* nudge left a bit */
        }

        .app-sidebar-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .app-sidebar-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: white;
            letter-spacing: -0.02em;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.0;
            margin-top: 0;
        }

        .app-sidebar-subtitle {
            font-size: 0.78rem;
            color: rgba(255, 255, 255, 0.85);
            text-transform: none;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            letter-spacing: 0.02em;
            margin-top: 0;
        }

        /* Navigation */
        .app-nav {
            flex: 1;
            padding: 0.75rem;
            overflow-y: auto;
        }

        .app-nav-section {
            margin-bottom: 1.5rem;
        }

        .app-nav-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.25rem;
        }

        .app-nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .app-nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .app-nav-item.active {
            background: linear-gradient(135deg, rgba(0, 180, 166, 0.2), rgba(30, 90, 142, 0.2));
            color: #00B4A6;
            border: 1px solid rgba(0, 180, 166, 0.3);
        }

        .app-nav-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }

        .app-nav-item.active .app-nav-item-icon {
            opacity: 1;
        }

        /* User section at bottom */
        .app-sidebar-footer {
            padding: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .app-user-button {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: white;
            width: 100%;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .app-user-button:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .app-user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #1E5A8E, #00B4A6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .app-user-info {
            flex: 1;
            min-width: 0;
        }

        .app-user-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .app-user-plan {
            font-size: 0.6875rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Main Content Area */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        .app-main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            flex-shrink: 0;
        }

        .app-main-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .app-version-tag {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 0.02em;
        }

        .app-main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Mobile sidebar toggle */
        .app-mobile-toggle {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: #CBD5E0;
            cursor: pointer;
        }

        .app-mobile-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Mobile overlay */
        .app-sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        @media (max-width: 768px) {
            .app-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
            }

            .app-sidebar.open {
                transform: translateX(0);
            }

            .app-sidebar-overlay.open {
                display: block;
            }

            .app-mobile-toggle {
                display: flex;
            }

            .app-main-content {
                padding: 1rem;
            }
        }

        /* Content Cards */
        .content-card {
            background: rgba(13, 47, 74, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            overflow: hidden;
        }

        .content-card-header {
            padding: 1rem 1.25rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .content-card-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .content-card-body {
            padding: 1.25rem;
        }

        /* Unified Input Area */
        .unified-input-area {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .unified-textarea {
            width: 100%;
            min-height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            color: #F7FAFC;
            font-size: 0.9375rem;
            resize: vertical;
            outline: none;
            transition: all 0.2s ease;
        }

        .unified-textarea:focus {
            border-color: #00B4A6;
            box-shadow: 0 0 0 2px rgba(0, 180, 166, 0.2);
        }

        .unified-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: #CBD5E0;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .quick-action-btn:hover {
            background: rgba(0, 180, 166, 0.15);
            border-color: rgba(0, 180, 166, 0.3);
            color: #00B4A6;
        }

        .quick-action-btn.primary {
            background: linear-gradient(135deg, #00B4A6, #1E5A8E);
            border-color: transparent;
            color: white;
        }

        .quick-action-btn.primary:hover {
            box-shadow: 0 4px 12px rgba(0, 180, 166, 0.3);
            transform: translateY(-1px);
        }

        /* File Drop Zone */
        .file-drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: rgba(0, 180, 166, 0.4);
            background: rgba(0, 180, 166, 0.05);
        }

        .file-drop-zone.drag-over {
            border-color: #00B4A6;
            background: rgba(0, 180, 166, 0.1);
        }

        .file-drop-zone-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Chat History in Sidebar */
        .chat-history-list {
            margin-top: 0.5rem;
        }

        .chat-history-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.15s ease;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
        }

        .chat-history-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .chat-history-item.active {
            background: rgba(0, 180, 166, 0.1);
            color: #00B4A6;
        }

        .chat-history-item-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history-item-delete {
            opacity: 0;
            padding: 0.25rem;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            border-radius: 0.25rem;
        }

        .chat-history-item:hover .chat-history-item-delete {
            opacity: 1;
        }

        .chat-history-item-delete:hover {
            color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useCallback, useEffect } = React;

        // Icon components (simplified SVG icons)
        const Icons = {
            Loader: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                </svg>
            ),
            X: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            ),
            Users: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            ),
            User: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            ),
            Copy: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            ),
            History: ({ size = 20 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 .49-11"></path>
                    <polyline points="12 7 12 12 15 15"></polyline>
                </svg>
            ),
            Upload: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
            ),
            FileText: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            ),
            File: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                    <polyline points="13 2 13 9 20 9"></polyline>
                </svg>
            ),
            Download: ({ size = 20 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            ),
            Check: ({ size = 16, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            ),
            CheckCircle: ({ size = 16, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            ),
            SuccessCheck: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            ),
            Zap: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
            ),
            Eye: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            ),
            EyeOff: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M17.94 17.94A10 10 0 0 1 12 20c-7 0-11-8-11-8a18.2 18.2 0 0 1 4.06-3.11"></path>
                    <path d="M1 1l22 22"></path>
                    <path d="M9.88 9.88A3 3 0 0 0 14 14"></path>
                </svg>
            ),
            AlertCircle: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            ),
            Heading: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M6 12h12"></path>
                    <path d="M6 4v16"></path>
                    <path d="M18 4v16"></path>
                </svg>
            ),
            List: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
            ),
            Table: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"></path>
                </svg>
            ),
            Book: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
            ),
            Settings: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            ),
            Scan: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path></svg>
            ),
            Layout: ({ size = 20 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            ),
            ChevronDown: ({ size = 16 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            ),
            Share: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
            ),
            Refresh: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
            ),
            Maximize: ({ size = 20, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
            ),
            Star: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
            ),
            // AI Assistant Icon
            Brain: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-2.54"></path>
                    <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-2.54"></path>
                </svg>
            ),
            Sparkles: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                    <path d="M5 3v4"></path>
                    <path d="M19 17v4"></path>
                    <path d="M3 5h4"></path>
                    <path d="M17 19h4"></path>
                </svg>
            ),
            ChatExpand: ({ size = 20 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
            ),
            Menu: ({ size = 20 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            ),
            Send: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            ),
            Trash: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            ),
            Edit: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                </svg>
            ),
            ChevronUp: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
            ),
            RefreshCw: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M21 2v6h-6"></path>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                    <path d="M3 22v-6h6"></path>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                </svg>
            ),
            Gift: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <polyline points="20 12 20 22 4 22 4 12"></polyline>
                    <rect x="2" y="7" width="20" height="5"></rect>
                    <line x1="12" y1="22" x2="12" y2="7"></line>
                    <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                    <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
                </svg>
            ),
            Square: ({ size = 24, fill = "none", className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
            ),
            MessageCircle: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
            ),
            MessageSquare: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            ),
            ChevronLeft: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            ),
            ChevronRight: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            ),
            ExternalLink: ({ size = 24 }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
            )
        };

        // API Configuration
        // Use current origin to ensure same-origin requests (avoids CORS issues)
        const API_BASE = window.location.origin || 'http://localhost:5000';
        const REMEMBERED_USER_KEY = 'afrodocs_remembered_user';

        // ============================================================================
        // MOBILE PDF VIEWER COMPONENT (simple iframe embed)
        // ============================================================================
        const MobilePdfViewer = ({ pdfUrl, maxHeight = 400 }) => {
            const [loading, setLoading] = useState(true);
            const [showPreview, setShowPreview] = useState(false);

            // Use backend wrapper page for mobile embedding to improve compatibility
            const embedUrl = pdfUrl ? `${API_BASE}/mobile-pdf-viewer?file=${encodeURIComponent(pdfUrl)}` : '';

            return (
                <div className="flex flex-col h-full">
                    {/* PDF iframe container */}
                    <div 
                        className="flex-1 overflow-hidden bg-gradient-to-b from-slate-800 to-slate-900 rounded-lg relative"
                        style={{ height: `${maxHeight}px` }}
                    >
                        {!showPreview ? (
                            /* Centered Open Button with Info Message */
                            <div className="absolute inset-0 flex flex-col items-center justify-center p-6 text-center">
                                {/* Open Button */}
                                <a 
                                    href={pdfUrl}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-teal to-cyan-600 text-white rounded-full font-semibold text-sm hover:opacity-90 transition-all shadow-lg mb-4"
                                >
                                    Open Full PDF
                                </a>
                                
                                {/* Info Message - minimal transparent box */}
                                <div className="w-full max-w-xs bg-white/5 border border-white/10 rounded-md p-3 text-center">
                                    <p className="text-mist text-sm leading-relaxed">Document display may vary on mobile devices depending on your document reader. For the best layout and full access to the Table of Contents, please download and open this file on a PC.</p>
                                </div>
                                
                                {/* Inline preview option removed for clarity */}
                            </div>
                        ) : (
                            /* Actual PDF Preview */
                            <>
                                {loading && (
                                    <div className="absolute inset-0 flex items-center justify-center text-mist flex-col gap-4 p-6 z-10 bg-slate-800">
                                        <div className="lightning-loading">
                                            <Icons.Zap />
                                        </div>
                                        <p className="text-sm">Loading PDF...</p>
                                    </div>
                                )}
                                <iframe
                                    src={embedUrl}
                                    className="w-full h-full border-0 rounded-lg"
                                    style={{ minHeight: `${maxHeight}px` }}
                                    onLoad={() => setLoading(false)}
                                    title="PDF Preview"
                                />
                            </>
                        )}
                    </div>
                    {/* Open in new tab link - always visible */}
                    <div className="flex items-center justify-center gap-3 py-3 bg-black/40 border-t border-white/10">
                        <a 
                            href={pdfUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-sm text-teal hover:text-teal/80 flex items-center gap-1.5 font-medium"
                        >
                            <Icons.ExternalLink size={14} /> Open Preview
                        </a>
                    </div>
                </div>
            );
        };

        // ============================================================================
        // AI ASSISTANT COMPONENT
        // ============================================================================
        
        // Helper function to parse markdown-like formatting in AI responses
        const parseAIResponse = (text) => {
            if (!text) return '';

            // Normalize line endings
            let content = text.replace(/\r\n/g, '\n');

            // Convert markdown tables (pipe syntax) to HTML tables first
            const tableBlockRegex = /(^\|.*\|\n\|[-: \|]*\|\n(?:\|.*\|\n?)*)/gm;
            content = content.replace(tableBlockRegex, (match) => {
                const lines = match.trim().split('\n');
                if (lines.length < 2) return match;
                const headerLine = lines[0].replace(/^\||\|$/g, '');
                const headers = headerLine.split('|').map(h => h.trim());
                const bodyLines = lines.slice(2).map(l => l.replace(/^\||\|$/g, '').split('|').map(c => c.trim()));
                const thead = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
                const tbody = bodyLines.map(r => '<tr>' + r.map(c => `<td>${c}</td>`).join('') + '</tr>').join('');
                return `<div class="ai-table-wrapper"><table>${thead}${tbody}</table></div>`;
            });

            // Convert markdown to HTML (no italics conversion per request)
            let html = content
                // Code blocks with language
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Bold
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                // Headers
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                // Unordered lists
                .replace(/^[\-\*] (.+)$/gm, '<li>$1</li>')
                // Ordered lists
                .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
                // Paragraphs (double newlines) -> wrap paragraphs
                .replace(/\n\n+/g, '</p><p>')
                // Single newlines -> treat as space
                .replace(/\n+/g, ' ');

            // Wrap consecutive li elements in ul
            html = html.replace(/(<li>.*?<\/li>)+/gs, (match) => `<ul>${match}</ul>`);

            // Wrap in paragraph if not starting with a block element
            if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<pre') && !html.startsWith('<div')) {
                html = '<p>' + html + '</p>';
            }

            // Sanitize unwanted assistant boilerplate and placeholders
            const sanitizePatterns = [
                /\(A preliminary list following APA 7th edition format\)/gi,
                /Submitted by:\s*\[?[^\n\]]*\]?/gi,
                /Institution:\s*\[?[^\n\]]*\]?/gi,
                /Date:\s*\[?[^\n\]]*\]?/gi,
                /Supervisor:\s*\[?[^\n\]]*\]?/gi
            ];
            for (const pat of sanitizePatterns) {
                html = html.replace(pat, '');
            }

            // Remove any remaining italics tags or markdown underscores
            html = html.replace(/<em>(.*?)<\/em>/g, '$1');
            html = html.replace(/_(.*?)_/g, '$1');

            // Ensure References header appears in all caps in chat display
            html = html.replace(/(<h[1-6]>\s*)(references)\s*(<\/h[1-6]>)/gi, (m, p1, p2, p3) => p1 + p2.toUpperCase() + p3);
            html = html.replace(/(<p>\s*)(references)\s*(<\/p>)/gi, (m, p1, p2, p3) => p1 + p2.toUpperCase() + p3);

            // Ensure headings are separated from following body text: if a closing heading
            // tag is immediately followed by text, insert a paragraph start so topics/subtopics
            // appear on their own line and body is in its own paragraph.
            html = html.replace(/<\/h([1-6])>\s*(?!<)/g, '<\/h$1><p>');

            // Close any paragraph that was started after a heading when the next block element
            // (another heading, ul, pre, div) or end-of-string is reached.
            html = html.replace(/(<p>[\s\S]*?)((?=<h)|(?=<ul)|(?=<pre)|(?=<div)|$)/g, (m, p1, p2) => {
                // If paragraph already closed, leave it
                if (p1.endsWith('</p>')) return m;
                return p1 + '</p>' + p2;
            });

            return html;
        };

        const AiAssistant = ({ isExpanded, onToggle, onFormatText, sidebarOpen: sidebarOpenProp, setSidebarOpen: setSidebarOpenProp }) => {
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isStreaming, setIsStreaming] = useState(false);
            const [streamingContent, setStreamingContent] = useState('');
            const [copiedIndex, setCopiedIndex] = useState(null);
            const [formattingIndex, setFormattingIndex] = useState(null);
            const [chatHistory, setChatHistory] = useState([]);
            const [currentChatId, setCurrentChatId] = useState(null);
            const [internalSidebarOpen, setInternalSidebarOpen] = useState(true);
            const sidebarOpen = typeof sidebarOpenProp !== 'undefined' ? sidebarOpenProp : internalSidebarOpen;
            const setSidebarOpen = setSidebarOpenProp || setInternalSidebarOpen;
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            const textareaRef = useRef(null);
            const sidebarRef = useRef(null);
            const toggleRef = useRef(null);

            // Load chat history from localStorage on mount
            useEffect(() => {
                const savedHistory = localStorage.getItem('afrodocs_chat_history');
                if (savedHistory) {
                    try {
                        const parsed = JSON.parse(savedHistory);
                        setChatHistory(parsed);
                    } catch (e) {
                        console.error('Failed to parse chat history:', e);
                    }
                }
            }, []);

            // Save chat history to localStorage
            useEffect(() => {
                if (chatHistory.length > 0) {
                    localStorage.setItem('afrodocs_chat_history', JSON.stringify(chatHistory));
                }
            }, [chatHistory]);

            // Save current chat when messages change
            useEffect(() => {
                if (currentChatId && messages.length > 0) {
                    setChatHistory(prev => prev.map(chat => 
                        chat.id === currentChatId 
                            ? { ...chat, messages, updatedAt: new Date().toISOString() }
                            : chat
                    ));
                }
            }, [messages, currentChatId]);

            // Auto-resize textarea
            const adjustTextareaHeight = () => {
                if (textareaRef.current) {
                    textareaRef.current.style.height = 'auto';
                    textareaRef.current.style.height = Math.min(textareaRef.current.scrollHeight, 200) + 'px';
                }
            };

            useEffect(() => {
                adjustTextareaHeight();
            }, [inputValue]);

            // Click-away handler: close sidebar when clicking outside (capture-phase pointer for reliability)
            useEffect(() => {
                function handleDocPointer(e) {
                    try {
                        if (!sidebarOpen) return;
                        const sidebarEl = sidebarRef.current;
                        const toggleEl = toggleRef.current;
                        const target = e.target;
                        if (sidebarEl && !sidebarEl.contains(target) && (!toggleEl || !toggleEl.contains(target))) {
                            setSidebarOpen(false);
                        }
                    } catch (err) {
                        // ignore
                    }
                }
                // Use capture to run before React handlers and pointer events to cover touch/mouse
                document.addEventListener('pointerdown', handleDocPointer, true);
                document.addEventListener('touchstart', handleDocPointer, true);
                return () => {
                    document.removeEventListener('pointerdown', handleDocPointer, true);
                    document.removeEventListener('touchstart', handleDocPointer, true);
                };
            }, [sidebarOpen, setSidebarOpen]);

            // Auto-scroll to bottom when new messages arrive
            useEffect(() => {
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages, streamingContent]);

            // Focus input when expanded
            useEffect(() => {
                if (isExpanded && inputRef.current) {
                    inputRef.current.focus();
                }
            }, [isExpanded]);

            const suggestedQuestions = [
                { text: "Write a project proposal", prompt: "Write a project proposal on the topic; " },
                { text: "Help with my assignment", prompt: "Help with my assignment on; " },
                { text: "Draft a report introduction", prompt: "Draft a report introduction for; " },
                { text: "Write my chapter one", prompt: "Write my chapter one on the topic; " }
            ];

            const handleSendMessage = async (messageText = inputValue) => {
                const trimmedMessage = messageText.trim();
                if (!trimmedMessage || isLoading) return;

                // Create a new chat if none exists
                if (!currentChatId) {
                    const newChat = {
                        id: Date.now().toString(),
                        title: trimmedMessage.substring(0, 30),
                        messages: [],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    setChatHistory(prev => [newChat, ...prev]);
                    setCurrentChatId(newChat.id);
                }

                // Add user message
                const userMessage = { role: 'user', content: trimmedMessage };
                setMessages(prev => [...prev, userMessage]);
                setInputValue('');
                // Reset textarea height
                if (textareaRef.current) {
                    textareaRef.current.style.height = 'auto';
                }
                setIsLoading(true);
                setIsStreaming(true);
                setStreamingContent('');

                try {
                    // Build conversation history for context
                    const conversationHistory = messages.map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));

                    // Try streaming first
                    const response = await fetch(`${API_BASE}/api/ai/chat/stream`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            message: trimmedMessage,
                            conversation: conversationHistory
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Stream failed, falling back to regular API');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    if (data.content) {
                                        fullContent += data.content;
                                        setStreamingContent(fullContent);
                                    } else if (data.done) {
                                        // Streaming complete
                                        break;
                                    } else if (data.error) {
                                        throw new Error(data.error);
                                    }
                                } catch (e) {
                                    // Skip malformed JSON
                                }
                            }
                        }
                    }

                    // Add assistant messages - split into content and comment
                    if (fullContent) {
                        const { mainContent, aiComment } = splitAIResponse(fullContent);
                        let sanitizedMain = sanitizeAiOutput(mainContent);
                        sanitizedMain = sanitizeAiBold(sanitizedMain);
                        // Add main content first (this is what can be formatted/copied)
                        if (sanitizedMain) {
                            setMessages(prev => [...prev, { role: 'assistant', content: sanitizedMain, isContent: true }]);
                        }
                        // Add AI comment separately (no format/copy buttons)
                        if (aiComment) {
                            setMessages(prev => [...prev, { role: 'assistant', content: aiComment, isComment: true }]);
                        }
                    }

                } catch (streamError) {
                    console.log('Streaming failed, trying regular API:', streamError);
                    
                    // Fallback to regular API
                    try {
                        const response = await fetch(`${API_BASE}/api/ai/chat`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                message: trimmedMessage,
                                conversation: messages.map(msg => ({
                                    role: msg.role,
                                    content: msg.content
                                }))
                            })
                        });

                        const data = await response.json();

                        if (data.success && data.response) {
                            // Split response into content and comment
                            const { mainContent, aiComment } = splitAIResponse(data.response);
                            let sanitizedMain = sanitizeAiOutput(mainContent);
                            sanitizedMain = sanitizeAiBold(sanitizedMain);
                            if (sanitizedMain) {
                                setMessages(prev => [...prev, { role: 'assistant', content: sanitizedMain, isContent: true }]);
                            }
                            if (aiComment) {
                                setMessages(prev => [...prev, { role: 'assistant', content: aiComment, isComment: true }]);
                            }
                        } else {
                            setMessages(prev => [...prev, { 
                                role: 'assistant', 
                                content: `I apologize, but I encountered an error: ${data.error || 'Unknown error'}. Please try again.`,
                                isComment: true
                            }]);
                        }
                    } catch (error) {
                        console.error('AI Chat error:', error);
                        setMessages(prev => [...prev, { 
                            role: 'assistant', 
                            content: 'I apologize, but I\'m having trouble connecting to the AI service. Please check your connection and try again.',
                            isComment: true
                        }]);
                    }
                } finally {
                    setIsLoading(false);
                    setIsStreaming(false);
                    setStreamingContent('');
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            const handleClearChat = () => {
                setMessages([]);
                setStreamingContent('');
                setCurrentChatId(null);
            };

            // Create a new chat
            const handleNewChat = () => {
                const newChat = {
                    id: Date.now().toString(),
                    title: 'New Chat',
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                setChatHistory(prev => [newChat, ...prev]);
                setCurrentChatId(newChat.id);
                setMessages([]);
                setStreamingContent('');
                setSidebarOpen(false);
            };

            // Load a chat from history
            const handleLoadChat = (chatId) => {
                const chat = chatHistory.find(c => c.id === chatId);
                if (chat) {
                    setMessages(chat.messages || []);
                    setCurrentChatId(chatId);
                    setSidebarOpen(false);
                }
            };

            // Delete a chat from history
            const handleDeleteChat = (chatId, e) => {
                e.stopPropagation();
                setChatHistory(prev => prev.filter(c => c.id !== chatId));
                if (currentChatId === chatId) {
                    setMessages([]);
                    setCurrentChatId(null);
                }
            };

            // Get chat title from first user message
            const getChatTitle = (chat) => {
                const firstUserMsg = chat.messages?.find(m => m.role === 'user');
                if (firstUserMsg) {
                    return firstUserMsg.content.length > 30 
                        ? firstUserMsg.content.substring(0, 30) + '...' 
                        : firstUserMsg.content;
                }
                return 'New Chat';
            };

            // Format date for display
            const formatChatDate = (dateStr) => {
                const date = new Date(dateStr);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                return date.toLocaleDateString();
            };

            // Split AI response into content and comment parts
            const splitAIResponse = (content) => {
                // Do not separate assistant meta-notes from the main response.
                // Return the full content as the main response so users receive
                // a single, final assistant message (no trailing AI Notes).
                const mainContent = (content || '').replace(/^---+\s*\n/gm, '').replace(/\n---+\s*$/gm, '').trim();
                return { mainContent, aiComment: '' };
            };

            // Strip AI comments/meta text from content for formatting
            const stripAIComments = (content) => {
                const { mainContent } = splitAIResponse(content);
                return mainContent;
            };

            const sanitizeAiBold = (content) => {
                if (!content) return content;
                const headingRegex = /^(?:\s*\**\s*(?:chapter|table of contents|references|bibliography)\b|\s*\**\s*\d+(?:\.\d+){0,3}\s+\S+|\s*\**\s*[A-Z][A-Z\s]{3,})/i;
                return content
                    .split('\n')
                    .map(line => (line.includes('**') && !headingRegex.test(line) ? line.replace(/\*\*/g, '') : line))
                    .join('\n');
            };

            const sanitizeAiStructure = (content) => {
                if (!content) return content;
                const mixedAlphaNumeric = /^\s*\d+\s*[a-zA-Z][\)\.\:]?\s+/i;
                const lettered = /^\s*(?:\d+\s+)?[a-z][\)\.]\s+/i;
                const roman = /^\s*(?:\d+\s+)?(?:i{1,4}|v|vi{0,3}|ix|x)[\)\.\:]?\s+/i;
                return content
                    .split('\n')
                    .map(line => {
                        const trimmed = line.trim();
                        if (!trimmed) return line;
                        if (mixedAlphaNumeric.test(trimmed)) {
                            const updated = trimmed.replace(mixedAlphaNumeric, '');
                            return `- ${updated}`;
                        }
                        if (lettered.test(trimmed)) {
                            const updated = trimmed.replace(lettered, '');
                            return `- ${updated}`;
                        }
                        if (roman.test(trimmed) && !/^chapter\b/i.test(trimmed)) {
                            const updated = trimmed.replace(roman, '');
                            return `- ${updated}`;
                        }
                        return line;
                    })
                    .join('\n');
            };

            const sanitizeAiOutput = (content) => sanitizeAiStructure(sanitizeAiBold(content));

            const handleSuggestionClick = (suggestion) => {
                // Put the suggestion prompt in the input box for user to complete
                setInputValue(suggestion.prompt);
                if (textareaRef.current) {
                    textareaRef.current.focus();
                }
            };

            const handleCopyMessage = async (content, index) => {
                try {
                    await navigator.clipboard.writeText(content);
                    setCopiedIndex(index);
                    setTimeout(() => setCopiedIndex(null), 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };

            const handleFormatMessage = async (content, index) => {
                if (onFormatText) {
                    setFormattingIndex(index);
                    // Strip AI comments before formatting
                    const cleanedContent = sanitizeAiOutput(stripAIComments(content));
                    onFormatText(cleanedContent);
                    // Reset formatting index after a short delay since the modal will open
                    setTimeout(() => setFormattingIndex(null), 500);
                }
            };

            if (!isExpanded) {
                // When collapsed we render nothing â€” the AI is opened from the main header
                return null;
            }

            return (
                <>
                <div className="ai-chat-container">
                    <div className="ai-layout-container">
                        {/* Overlay for mobile - click to close sidebar */}
                        <div 
                            className={`ai-sidebar-overlay ${sidebarOpen ? 'open' : ''}`}
                            onClick={() => setSidebarOpen(false)}
                        />
                        
                        {/* Sidebar with chat history */}
                        <div className={`ai-sidebar ${sidebarOpen ? 'open' : ''}`} ref={sidebarRef}>
                            <div className="ai-sidebar-header">
                                <button onClick={handleNewChat} className="ai-new-chat-btn" title="New Chat">
                                    <span>+</span> New
                                </button>
                                <button
                                    onClick={() => setSidebarOpen(false)}
                                    className="ai-sidebar-toggle"
                                    style={{display: 'flex'}}
                                    title="Collapse chat history"
                                >
                                    <Icons.History size={16} />
                                </button>
                            </div>
                            <div className="ai-chat-list">
                                {chatHistory.length === 0 ? (
                                    <div className="text-center text-mist/50 text-xs py-4">
                                        No chats yet
                                    </div>
                                ) : (
                                    chatHistory.map(chat => (
                                        <div
                                            key={chat.id}
                                            onClick={() => handleLoadChat(chat.id)}
                                            className={`ai-chat-item ${currentChatId === chat.id ? 'active' : ''}`}
                                        >
                                            <div className="ai-chat-item-content">
                                                <div className="ai-chat-item-title">{getChatTitle(chat)}</div>
                                                <div className="ai-chat-item-date">{formatChatDate(chat.updatedAt)}</div>
                                            </div>
                                            <button
                                                onClick={(e) => handleDeleteChat(chat.id, e)}
                                                className="ai-chat-item-delete"
                                                title="Delete chat"
                                            >
                                                <Icons.Trash size={12} />
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Main chat area */}
                        <div className="ai-main-content">
                            {/* Header */}
                            <div className="ai-header">
                                <div className="ai-header-title">
                                        <button 
                                            onClick={() => setSidebarOpen(!sidebarOpen)}
                                            className="ai-sidebar-toggle"
                                            title="Toggle chat history"
                                            ref={toggleRef}
                                        >
                                            <Icons.History size={16} />
                                        </button>
                                        <div className="ai-subtitle">AfroDocs, Write and Instantly format</div>
                                    </div>
                                <div className="flex items-center gap-2">
                                    {messages.length > 0 && (
                                        <button 
                                            onClick={handleClearChat}
                                            className="ai-clear-button"
                                            title="New chat"
                                        >
                                            <Icons.Trash size={14} />
                                        </button>
                                    )}
                                    {/* Collapse button removed as requested */}
                                </div>
                            </div>

                            {/* Messages Area */}
                            <div className="ai-messages-container">
                        {messages.length === 0 && !isStreaming ? (
                            <div className="ai-welcome-screen">
                                <h3 className="text-xl font-bold text-white mb-3">I can assist you!</h3>
                                <p className="text-mist text-sm mb-4 max-w-md leading-relaxed">
                                    I can help you write your projects, do your assignments, write your reports. Just ask me anything!
                                </p>
                                <div className="ai-suggestion-chips">
                                    {suggestedQuestions.map((question, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => handleSuggestionClick(question)}
                                            className="ai-suggestion-chip"
                                        >
                                            {question.text}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <>
                                {messages.map((message, idx) => (
                                    <div
                                        key={idx}
                                        className={`ai-message ${message.role === 'user' ? 'ai-message-user' : 'ai-message-assistant'} ${message.isComment ? 'ai-message-comment' : ''}`}
                                    >
                                        {message.role === 'assistant' ? (
                                            <>
                                                {message.isComment && (
                                                    <div className="text-xs text-mist/70 mb-1 italic flex items-center gap-1">
                                                        <Icons.MessageCircle size={12} />
                                                        AI Note
                                                    </div>
                                                )}
                                                <div dangerouslySetInnerHTML={{ __html: parseAIResponse(message.content) }} />
                                                {/* Action buttons only for content messages, not comments */}
                                                {!message.isComment && (
                                                <div className="ai-message-actions">
                                                    <button
                                                        onClick={() => handleCopyMessage(message.content, idx)}
                                                        className={`ai-action-button ${copiedIndex === idx ? 'copied' : ''}`}
                                                        title="Copy to clipboard"
                                                    >
                                                        {copiedIndex === idx ? (
                                                            <>
                                                                <Icons.Check size={14} />
                                                                Copied!
                                                            </>
                                                        ) : (
                                                            <>
                                                                <Icons.Copy size={14} />
                                                                Copy
                                                            </>
                                                        )}
                                                    </button>
                                                    <button
                                                        onClick={() => handleFormatMessage(message.content, idx)}
                                                        className="ai-action-button ai-action-button-format"
                                                        title="Format as document"
                                                        disabled={formattingIndex === idx}
                                                    >
                                                        {formattingIndex === idx ? (
                                                            <>
                                                                <Icons.Loader size={14} />
                                                                Formatting...
                                                            </>
                                                        ) : (
                                                            <>
                                                                <Icons.FileText size={14} />
                                                                Format Document
                                                            </>
                                                        )}
                                                    </button>
                                                </div>
                                                )}
                                            </>
                                        ) : (
                                            message.content
                                        )}
                                    </div>
                                ))}
                                
                                {/* Streaming content */}
                                {isStreaming && streamingContent && (
                                    <div className="ai-message ai-message-assistant">
                                        <div dangerouslySetInnerHTML={{ __html: parseAIResponse(streamingContent) }} />
                                    </div>
                                )}
                                
                                {/* Loading indicator */}
                                {isLoading && !streamingContent && (
                                    <div className="ai-thinking-indicator">
                                        <div className="ai-thinking-dots">
                                            <span></span>
                                            <span></span>
                                            <span></span>
                                        </div>
                                        <span>Thinking...</span>
                                    </div>
                                )}
                                
                                <div ref={messagesEndRef} />
                            </>
                        )}
                            </div>

                            {/* Input Area */}
                            <div className="ai-input-container">
                                <textarea
                                    ref={textareaRef}
                                    value={inputValue}
                                    onChange={(e) => {
                                        setInputValue(e.target.value);
                                        // Auto-resize textarea
                                        e.target.style.height = 'auto';
                                        e.target.style.height = Math.min(e.target.scrollHeight, 150) + 'px';
                                    }}
                                    onKeyDown={handleKeyDown}
                                    placeholder="Ask anything..."
                                    className="ai-input ai-textarea"
                                    disabled={isLoading}
                                    rows={1}
                                />
                                <button
                                    onClick={() => handleSendMessage()}
                                    disabled={!inputValue.trim() || isLoading}
                                    className="ai-send-button"
                                    title="Send message"
                                >
                                    {isLoading ? (
                                        <Icons.Loader size={18} />
                                    ) : (
                                        <Icons.Send size={18} />
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                </>
            );
        };

        // ============================================================================

        // PDF Preview Modal Component
        const PdfPreviewModal = ({ url, onClose, viewParam = 'FitH' }) => {
            if (!url) return null;

            // Determine effective view parameter based on screen size
            // On mobile (< 768px), force FitH (Fit Horizontal) for better readability
            // On desktop, respect the passed viewParam (which might be FitV for cover pages)
            const isMobile = window.innerWidth < 768;
            const effectiveViewParam = isMobile ? 'FitH' : viewParam;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-2 sm:p-4 md:p-8">
                    <div className="bg-ocean-dark w-full h-full max-h-screen sm:max-h-[95vh] md:max-w-6xl rounded-lg sm:rounded-2xl shadow-2xl flex flex-col border border-teal/30 overflow-hidden">
                        <div className="flex items-center justify-between p-2 sm:p-3 md:p-4 border-b border-white/10 bg-black/20 flex-shrink-0">
                            <h3 className="text-white font-bold text-sm sm:text-base md:text-lg flex items-center gap-1 sm:gap-2">
                                <span className="text-teal scale-75 sm:scale-90 md:scale-100"><Icons.Eye /></span>
                                <span className="hidden sm:inline">Document</span> Preview
                            </h3>
                            <button 
                                onClick={onClose}
                                className="p-1 sm:p-2 hover:bg-white/10 rounded-full text-mist hover:text-white transition-colors"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="sm:w-6 sm:h-6">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div className="flex-1 relative bg-slate-900 overflow-hidden" onContextMenu={(e) => e.preventDefault()}>
                            <iframe 
                                src={`${url}#toolbar=0&navpanes=0&scrollbar=0&view=${effectiveViewParam}`}
                                className="w-full h-full border-0"
                                title="PDF Preview"
                            />
                            {/* Overlay to prevent drag/drop or right click interactions if needed */}
                            <div className="absolute inset-0 pointer-events-none" />
                        </div>
                        <div className="p-2 sm:p-3 bg-black/40 text-center text-xs text-mist border-t border-white/5 flex-shrink-0">
                            Preview Mode - Download Disabled
                        </div>
                    </div>
                </div>
            );
        };

        // Auth Component
        const AuthPage = ({ onLogin, isSignup = true, guestLimitMessage = null }) => {
            const [isLogin, setIsLogin] = React.useState(!isSignup);
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [email, setEmail] = React.useState('');
            const [referralCode, setReferralCode] = React.useState('');
            const [institution, setInstitution] = React.useState('');
            const [institutions, setInstitutions] = React.useState([]);
            const [rememberMe, setRememberMe] = React.useState(true);

            React.useEffect(() => {
                // Fetch institutions from backend
                fetch(`${API_BASE}/api/institutions`)
                    .then(res => res.json())
                    .then(data => {
                        const institutionsList = data.institutions || data;
                        setInstitutions(Array.isArray(institutionsList) ? institutionsList : []);
                        if (Array.isArray(institutionsList) && institutionsList.length > 0) {
                            setInstitution(institutionsList[0].id);
                        }
                    })
                    .catch(err => {
                        console.error("Failed to fetch institutions:", err);
                        setInstitutions(FALLBACK_INSTITUTIONS);
                        setInstitution(FALLBACK_INSTITUTIONS[0].id);
                    });
            }, []);

            React.useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const ref = params.get('ref');
                if (ref) {
                    setReferralCode(ref);
                    setIsLogin(false); // Switch to signup if ref is present
                }
            }, []);

            React.useEffect(() => {
                if (!isLogin) return;
                const saved = localStorage.getItem(REMEMBERED_USER_KEY);
                if (!saved) return;
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed?.username) {
                        setUsername(parsed.username);
                        setRememberMe(true);
                    }
                } catch (err) {
                    console.warn('Failed to load remembered user info.', err);
                }
            }, [isLogin]);
            const [customInstitution, setCustomInstitution] = React.useState('');
            const [contact, setContact] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [showPassword, setShowPassword] = React.useState(false);
            const errorIsPositive = error && /account created|already created|please log in/i.test(error);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                const endpoint = isLogin ? '/api/auth/login' : '/api/auth/signup';
                const finalInstitution = (institution === 'Other (Specify)' || institution === 'Others' || institution === 'Other Institution') ? customInstitution : institution;
                
                const payload = { username, password };
                if (!isLogin) {
                    payload.institution = finalInstitution;
                    payload.contact = contact;
                    payload.email = email;
                    payload.referral_code = referralCode;
                }
                
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        if (isLogin) {
                            if (rememberMe) {
                                localStorage.setItem(REMEMBERED_USER_KEY, JSON.stringify({ username }));
                            } else {
                                localStorage.removeItem(REMEMBERED_USER_KEY);
                            }
                            onLogin(data.username);
                        } else {
                            // Auto login after signup or switch to login
                            setIsLogin(true);
                            setError('Account created! Please log in.');
                        }
                    } else {
                        setError(data.error || 'Authentication failed');
                    }
                } catch (err) {
                    setError('Network error. Please try again.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass-panel rounded-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="flex justify-center mb-4">
                                <div className="bg-teal/20 p-3 rounded-xl">
                                    <span className="text-teal scale-150"><Icons.FileText size={32} /></span>
                                </div>
                            </div>
                            <h2 className="text-2xl font-bold text-white mb-2">
                                {isLogin ? 'Welcome Back' : 'Create Account'}
                            </h2>
                            <p className="text-slate-400">
                                {isLogin ? 'Sign in to continue to AfroDocs' : 'Join AfroDocs to format your documents'}
                            </p>
                        </div>

                        {guestLimitMessage && !isLogin && (
                            <div className="bg-teal/20 border border-teal/50 text-teal p-4 rounded-lg mb-6 text-center">
                                <Icons.Gift className="inline-block mb-2" size={24} />
                                <p className="font-medium">{guestLimitMessage}</p>
                            </div>
                        )}

                        {error && (
                            <div className="bg-red-500/20 border border-red-500/50 text-red-200 p-3 rounded-lg mb-6 text-sm text-center">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Username</label>
                                <input 
                                    type="text" 
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full glass-input rounded-lg p-2.5 text-white placeholder-white/30 focus:border-teal outline-none"
                                    placeholder="Enter username"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Password</label>
                                <div className="relative">
                                    <input 
                                        type={showPassword ? 'text' : 'password'} 
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full glass-input rounded-lg p-2.5 text-white placeholder-white/30 focus:border-teal outline-none pr-10"
                                        placeholder="Enter password"
                                        required
                                    />
                                    <button type="button" onClick={() => setShowPassword(prev => !prev)} className="absolute right-2 top-1/2 -translate-y-1/2 text-mist p-1">
                                        {showPassword ? <Icons.EyeOff size={18} /> : <Icons.Eye size={18} />}
                                    </button>
                                </div>
                            </div>
                            {isLogin && (
                                <label className="flex items-center gap-2 text-xs text-slate-300">
                                    <input
                                        type="checkbox"
                                        className="accent-teal"
                                        checked={rememberMe}
                                        onChange={(e) => setRememberMe(e.target.checked)}
                                    />
                                    Remember me on this browser
                                </label>
                            )}

                            {!isLogin && (
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-1">Email (Optional)</label>
                                    <input 
                                        type="email" 
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full glass-input rounded-lg p-2.5 text-white placeholder-white/30 focus:border-teal outline-none"
                                        placeholder="Enter email"
                                    />
                                </div>
                            )}

                            {!isLogin && (
                                <>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">Institution</label>
                                        <select 
                                            value={institution}
                                            onChange={(e) => setInstitution(e.target.value)}
                                            className="w-full glass-input rounded-lg p-2.5 text-white placeholder-white/30 focus:border-teal outline-none bg-midnight"
                                        >
                                            <option value="">Select Institution</option>
                                            {institutions.map(inst => (
                                                <option key={inst.id} value={inst.id}>{inst.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    {(institution === 'Other Institution' || institution === 'Others' || institution === 'Other (Specify)') && (
                                        <div>
                                            <input 
                                                type="text" 
                                                value={customInstitution}
                                                onChange={(e) => setCustomInstitution(e.target.value)}
                                                className="w-full glass-input rounded-lg p-2.5 text-white placeholder-white/30 focus:border-teal outline-none mt-2"
                                                placeholder="Specify Institution"
                                                required
                                            />
                                        </div>
                                    )}
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">Contact</label>
                                        <input 
                                            type="text" 
                                            value={contact}
                                            onChange={(e) => setContact(e.target.value)}
                                            className="w-full glass-input rounded-lg p-2.5 text-white placeholder-white/30 focus:border-teal outline-none"
                                            placeholder="Phone or Email"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-1">Promo Code (Optional)</label>
                                        <input 
                                            type="text" 
                                            value={referralCode}
                                            onChange={(e) => setReferralCode(e.target.value)}
                                            className="w-full glass-input rounded-lg p-2.5 text-white placeholder-white/30 focus:border-teal outline-none"
                                            placeholder="Enter promo code"
                                        />
                                    </div>
                                </>
                            )}
                            
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-teal hover:bg-teal-light text-white font-bold py-2.5 rounded-lg transition-all shadow-lg shadow-teal/20 disabled:opacity-50 disabled:cursor-not-allowed mt-2"
                            >
                                {loading ? 'Processing...' : (isLogin ? 'Sign In' : 'Create Account')}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            <button 
                                onClick={() => { setIsLogin(!isLogin); setError(''); }}
                                className="text-teal hover:text-teal-light text-sm font-medium transition-colors"
                            >
                                {isLogin ? "Don't have an account? Sign up" : "Already have an account? Sign in"}
                            </button>
                        </div>
                        

                    </div>
                </div>
            );
        };

        // Fallback Data
        const FALLBACK_INSTITUTIONS = [
            {
            "id": "uba",
            "name": "The University of Bamenda",
            "short": "UBa",
            "logo": "uba_logo.png",
            "faculties": [
                {
                "name": "College of Technology",
                "departments": [
                    "Telecommunications",
                    "Agribusiness Marketing Management",
                    "Agribusiness Project Management",
                    "Integrated Development and Management Studies",
                    "Agricultural Power Engineering",
                    "Water Resource Engineering",
                    "Maintenance and Production Engineering",
                    "Animal Nutrition and Feeding",
                    "Animal Production Technology",
                    "Biotechnology and Animal Science: Reproductive Physiology and Animal Health",
                    "Biotechnology and Animal Science: Animal Nutrition and Feeding",
                    "Reproductive Physiology and Animal Health",
                    "Wildlife Resource Management",
                    "Forest Resource Management",
                    "Wildlife Resources Management",
                    "Forest Resource Management - Forest Economics",
                    "Computer Engineering - Data Science",
                    "Computer Engineering - Information Technology and Cyber Security",
                    "Crop Production Technology",
                    "Electrical Power Engineering",
                    "Food Science and Human Nutrition",
                    "Food Science and Bioresource Technology",
                    "Nutritional Sciences",
                    "Food and Bioresource Technology",
                    "Environmental Technology",
                    "Bioenergy Engineering",
                    "Satellite Communications",
                    "Renewable Energy Engineering",
                    "Didactics, Curriculum Development and Teaching",
                    "Computer Engineering",
                    "Computer Networks and Systems Maintenance",
                    "Computer Software Engineering",
                    "Software Engineering",
                    "Electrical and Electronics Engineering",
                    "Electric and Power Engineering",
                    "Electric Power Engineering",
                    "Electronic Engineering",
                    "Telecommunication"
                ]
                },
                {
                "name": "Faculty of Arts",
                "departments": [
                    "International Studies",
                    "Translation",
                    "Communication and Development Studies",
                    "Geography and Planning",
                    "Economic and Social Development History",
                    "Heritage and Cultural History",
                    "History and Public Policy: Option - Decentralization and Local Governance",
                    "English Language",
                    "Literatures in English",
                    "Linguistics and African Languages",
                    "Applied Linguistics",
                    "Theatre, Television and Film Studies",
                    "Visual Arts and History of Arts",
                    "Philosophy",
                    "English Language and Literature Teaching",
                    "Literature and Digital cultures",
                    "Communication",
                    "Evaluation and Measurement",
                    "Subject Didactics",
                    "History and Archaeology",
                    "Cameroonian Languages and Cultures",
                    "African Renaissance Studies",
                    "Mother Tongue Education",
                    "Music and Dance",
                    "Bilingual Letters",
                    "Functional Language Enhancement",
                    "Intercultural Communication and Mediation Studies",
                    "Multilingual and Intercultural Communication",
                    "Literary and Digital Cultures",
                    "Language and Literature Teaching"
                ]
                },
                {
                "name": "Faculty of Economics and Management Sciences",
                "departments": [
                    "Accounting",
                    "Management",
                    "Economics",
                    "Health Economics, Policy and Management",
                    "Environmental Economics, Policy and Management",
                    "Marketing",
                    "Human Resource Management",
                    "Banking and Finance",
                    "Finance and Investment",
                    "Islamic Banking and Finance",
                    "Quantitative Finance"
                ]
                },
                {
                "name": "Faculty of Education",
                "departments": [
                    "Environmental Education",
                    "History of Education",
                    "Philosophy of Education",
                    "Sociology of Education",
                    "Educational Measurement and Evaluation",
                    "Applied Developmental Psychology",
                    "Community Psychology",
                    "Educational Psychology",
                    "Teacher Education",
                    "Educational Leadership and Management",
                    "Higher Education Development & Governance",
                    "Economics and Finance of Education",
                    "Educational Technology",
                    "Curriculum Planning and Design",
                    "Pedagogy",
                    "Inclusive Education",
                    "Physical Education and Animation",
                    "Health Psychology",
                    "Clinical Counseling",
                    "Counselling",
                    "Teaching Science, Technology, Engineering and Mathematics",
                    "Educational Leadership",
                    "Educational Foundations",
                    "Secondary Education",
                    "Nomadic Teacher Education",
                    "STEM Education",
                    "Inspection & Supervision of Instructions",
                    "Curriculum Pedagogy",
                    "Braille and Sign Language",
                    "Recreation and Leisure Studies",
                    "Guidance and Counselling",
                    "Social and Organizational Psychology",
                    "Social Work",
                    "Psychology of Education",
                    "Supervision of Instruction",
                    "Early Childhood Development",
                    "Early Childhood Care and Education",
                    "Measurement and Evaluation",
                    "Primary Education",
                    "Technical Education",
                    "Economics of Education",
                    "Educational Leadership in Basic Education",
                    "Educational Leadership in Secondary Education",
                    "School Principalship",
                    "Library, Archival and Information Science",
                    "Physical and Health Education",
                    "Sport Psychology",
                    "Coaching",
                    "Wellness and Fitness Instruction",
                    "Bereavement Counseling",
                    "Industrial and Organizational Psychology",
                    "School Counseling",
                    "Health Counselling",
                    "Distance Education"
                ]
                },
                {
                "name": "Faculty of Health Sciences",
                "departments": [
                    "Chemical Pathology",
                    "Pharmacology and Toxicology",
                    "Medical Laboratory Science",
                    "Midwifery Science",
                    "Medical-Surgical Nursing",
                    "Psychiatric Nursing",
                    "Paediatric Nursing",
                    "Oncology Nursing",
                    "Public Health",
                    "Biomedical Sciences",
                    "Medicine",
                    "Pharmacology",
                    "Medical Laboratory Sciences (BMLS)",
                    "Nursing/Midwifery",
                    "Nursing Science",
                    "Nursing",
                    "Midwifery",
                    "Community Health",
                    "Pharmacy"
                ]
                },
                {
                "name": "Faculty of Law and Political Science",
                "departments": [
                    "Regional Integration",
                    "Internal Public Law",
                    "Public International Law",
                    "Public Administration and Policy",
                    "Negotiation, Mediation and Peace Building",
                    "International Relations and Strategic Studies",
                    "CapacitÃ© en Droit",
                    "Political Science",
                    "English Private Law",
                    "Property Law",
                    "Human Rights Law",
                    "Public Law",
                    "Public Policy and Public Administration",
                    "Comparative Politics",
                    "Anthropological Politics",
                    "International Law",
                    "Natural Resource Law",
                    "Law",
                    "Business Communication",
                    "Executive Studies in Business Negotiations and Contract Management",
                    "Energy, Petroleum and Mineral Law",
                    "Public Administration"
                ]
                },
                {
                "name": "Faculty of Science",
                "departments": [
                    "Thermal Engineering",
                    "Environmental Science",
                    "Probability and Statistics",
                    "Applied Mathematics",
                    "Physics",
                    "Food and Industrial Microbiology",
                    "Applied Botany",
                    "Applied Zoology",
                    "Biochemistry",
                    "Chemistry",
                    "Geology",
                    "Mathematics and Statistics",
                    "Microbiology",
                    "Geoscience",
                    "Applied Parasitology and Vector Biology",
                    "Medical Microbiology and Infectious Diseases",
                    "Industrial and Urban Waste Management",
                    "Applied Geology",
                    "Petroleum Geoscience",
                    "Biodiversity, Conservation and Management",
                    "Medicinal Plants"
                ]
                },
                {
                "name": "Higher Institute of Commerce and Management",
                "departments": [
                    "Real Estate Management",
                    "Development Finance",
                    "Project Management",
                    "Accounting and Finance",
                    "Insurance and Security",
                    "Marketing",
                    "Money and Banking",
                    "Management and Entrepreneurship",
                    "Human Resource Management",
                    "Executive Secretariat Duties",
                    "Environmental Accounting",
                    "Tax Accounting",
                    "Public Sector Accounting",
                    "Microfinance",
                    "Inventory and Supply Chain Management",
                    "Information and Communication Management",
                    "Local Government Management",
                    "Logistic Management",
                    "Supply Chain Management",
                    "Executive MBA"
                ]
                },
                {
                "name": "Higher Institute of Transport and Logistics",
                "departments": [
                    "Transportation",
                    "Port and Shipping Management",
                    "Logistics and Supply Chain Management",
                    "Tourism and Sustainable Environmental Management",
                    "Transit and Logistics",
                    "Tourism and Hospitality management",
                    "Maritime Transport",
                    "Tourism and cultural Heritage Development",
                    "Customs",
                    "Land Transport",
                    "Transport and Logistics Management",
                    "Air Transport"
                ]
                },
                {
                    "name": "National Higher Polytechnic Institute",
                    "departments": [
                        "Cybersecurity and Mathematical Cryptology",
                        "Chemical and Biological Engineering",
                        "Civil Engineering and Architecture",
                        "Computer Engineering",
                        "Meteorology (Engineering)",
                        "Electrical and Electronic Engineering",
                        "Mechanical and Industrial Engineering",
                        "Mining and Mineral Engineering",
                        "Petroleum Engineering"
                    ]
                }
            ]
            },
            {
            "id": "ub",
            "name": "University of Buea",
            "short": "UB",
            "logo": "ub_logo.png",
            "faculties": [
                {
                "name": "Faculty of Science",
                "departments": [
                    "Biochemistry",
                    "Botany",
                    "Chemistry",
                    "Computer Science",
                    "Environmental Science",
                    "Geology",
                    "Mathematics",
                    "Microbiology",
                    "Physics",
                    "Zoology"
                ]
                },
                {
                "name": "Faculty of Engineering and Technology",
                "departments": [
                    "Computer Engineering",
                    "Electrical and Electronic Engineering",
                    "Telecommunications Engineering"
                ]
                },
                {
                    "name": "Faculty of Social and Management Sciences",
                    "departments": [
                        "Accounting",
                        "Banking and Finance",
                        "Economics",
                        "Journalism and Mass Communication",
                        "Management",
                        "Political Science",
                        "Sociology and Anthropology",
                        "Women and Gender Studies"
                    ]
                }
            ]
            }
        ];

        // --- Cover Page Generator Component ---
        const CoverPageGenerator = ({ mergeJobId, setPdfPreviewUrl, pdfPreviewUrl, setPdfViewParam, setShowPdfModal, opening = false, setOpening = () => {} }) => {
            const [formData, setFormData] = useState({
                university: 'Bamenda',  // Add university selector
                documentType: 'Assignment',
                institution: '',
                faculty: '',
                department: '',
                courseCode: '',
                courseTitle: '',
                title: '',
                studentName: '',
                studentId: '',
                instructor: '',
                date: new Date().toISOString().split('T')[0],
                level: '300 Level',
                assignmentNumber: '',
                supervisor: '',
                coSupervisor: '',
                fieldSupervisor: '',
                academicSupervisor: '',
                defenseDate: '',
                groupMembers: [],
                projectDuration: ''
            });

            const [institutions, setInstitutions] = useState([]);
            const [faculties, setFaculties] = useState([]);
            const [departments, setDepartments] = useState([]);
            const [courseSuggestions, setCourseSuggestions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [generatedFile, setGeneratedFile] = useState(null);
            const [previewMode, setPreviewMode] = useState(false);
            const [institutionRequest, setInstitutionRequest] = useState('');
            const [institutionRequestMessage, setInstitutionRequestMessage] = useState('');
            const [showInstitutionThankYou, setShowInstitutionThankYou] = useState(false);

            // Load institutions on mount
            React.useEffect(() => {
                // Clear opening state immediately when component mounts
                if (opening) {
                    setOpening(false);
                }
                fetch(`${API_BASE}/api/institutions`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.institutions && data.institutions.length > 0) {
                            setInstitutions(data.institutions);
                        } else {
                            console.warn("API returned empty institutions, using fallback");
                            setInstitutions(FALLBACK_INSTITUTIONS);
                        }
                    })
                    .catch(err => {
                        console.error("Failed to load institutions", err);
                        setInstitutions(FALLBACK_INSTITUTIONS);
                    })
                    .finally(() => {
                        // Load saved profile after institutions are set (or fallback used)
                        const saved = localStorage.getItem('coverpage_profile');
                        if (saved) {
                            try {
                                const profile = JSON.parse(saved);
                                // We need to use the institutions data we just set (or fallback)
                                // But state update is async. So we use the data directly here.
                                // However, we can't easily access the data variable in catch/finally if it was in then.
                                // So we'll do the profile loading inside the then/catch blocks or use a separate effect.
                                // Actually, let's just do it in a separate effect that depends on institutions.
                            } catch (e) {
                                console.error("Error loading profile", e);
                            }
                        }
                    });
            }, []);

            // Effect to load profile once institutions are available
            // NOTE: We intentionally do NOT auto-select institution/faculty here.
            // The cover page should always default to 'Select Institution' and 'Select Faculty'
            React.useEffect(() => {
                if (institutions.length > 0) {
                    const saved = localStorage.getItem('coverpage_profile');
                    if (saved) {
                        try {
                            const profile = JSON.parse(saved);

                            // Only restore non-institution-specific fields. Keep institution/faculty/department blank
                            setFaculties([]);
                            setDepartments([]);

                            setFormData(prev => ({
                                ...prev,
                                studentName: profile.studentName || '',
                                studentId: profile.studentId || '',
                                institution: '',
                                faculty: '',
                                department: '',
                                level: profile.level || '300 Level'
                            }));
                        } catch (e) {
                            console.error("Error loading profile", e);
                        }
                    }
                }
            }, [institutions]);

            // Handle Institution Change
            const handleInstitutionChange = (e) => {
                const instId = e.target.value;
                const inst = institutions.find(i => i.id === instId);
                setFormData(prev => ({ ...prev, institution: instId, faculty: '', department: '' }));
                setFaculties(inst ? inst.faculties : []);
                setDepartments([]);
            };

            // Handle Faculty Change
            const handleFacultyChange = (e) => {
                const facName = e.target.value;
                const fac = faculties.find(f => f.name === facName);
                setFormData(prev => ({ ...prev, faculty: facName, department: '' }));
                setDepartments(fac ? fac.departments : []);
            };

            // Handle Course Code Auto-complete
            const handleCourseCodeChange = (e) => {
                const val = e.target.value;
                setFormData(prev => ({ ...prev, courseCode: val }));
                
                if (val.length >= 3) {
                    fetch(`${API_BASE}/api/courses/search?q=${val}`)
                        .then(res => res.json())
                        .then(data => {
                            setCourseSuggestions(data);
                            // Auto-fill title if exact match
                            const exact = data.find(c => c.code === val);
                            if (exact) {
                                setFormData(prev => ({ ...prev, courseTitle: exact.title }));
                            }
                        });
                } else {
                    setCourseSuggestions([]);
                }
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async () => {
                setLoading(true);
                
                // Scroll to top to show preview
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                try {
                    // Save profile
                    localStorage.setItem('coverpage_profile', JSON.stringify({
                        studentName: formData.studentName,
                        studentId: formData.studentId,
                        institution: formData.institution,
                        faculty: formData.faculty,
                        department: formData.department,
                        level: formData.level
                    }));

                    const response = await fetch(`${API_BASE}/api/coverpage/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...formData, mergeJobId }),
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        setGeneratedFile(data);
                        
                        // Update PDF preview URL immediately
                        const pdfFilename = data.filename ? data.filename.replace(/\.docx$/i, '.pdf') : 'formatted_document.pdf';
                        const previewUrl = `${API_BASE}/download-pdf/${data.job_id}/${encodeURIComponent(pdfFilename)}?inline=true`;
                        setPdfViewParam(mergeJobId ? 'FitH' : 'FitV');
                        setPdfPreviewUrl(previewUrl);
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (err) {
                    console.error(err);
                    alert('Failed to generate cover page');
                } finally {
                    setLoading(false);
                }
            };

            // Render Fields based on Document Type
            const renderDynamicFields = () => {
                const type = formData.documentType;
                
                if (type === 'Assignment') {
                    return (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="form-label">Level</label>
                                    <div className="relative">
                                        <select name="level" value={formData.level} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 pr-8 text-teal focus:border-teal outline-none appearance-none cursor-pointer text-base">
                                            <option value="200 Level" className="bg-ocean-dark text-white">200 Level</option>
                                            <option value="300 Level" className="bg-ocean-dark text-white">300 Level</option>
                                            <option value="400 Level" className="bg-ocean-dark text-white">400 Level</option>
                                            <option value="500 Level" className="bg-ocean-dark text-white">500 Level</option>
                                            <option value="Others" className="bg-ocean-dark text-white">Others</option>
                                        </select>
                                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-teal">
                                            <Icons.ChevronDown />
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="form-label">Instructor</label>
                                    <input type="text" name="instructor" value={formData.instructor} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="Dr. Charles Smith" />
                                </div>
                            </div>

                            {/* Custom Level Input for Assignment */}
                            {formData.level === "Others" && (
                                <div>
                                    <label className="form-label">Enter Level</label>
                                    <input 
                                        type="text" 
                                        name="levelCustom" 
                                        value={formData.levelCustom || ''} 
                                        onChange={handleInputChange} 
                                        className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" 
                                        placeholder="e.g., 600 Level, Masters Level, etc." 
                                    />
                                </div>
                            )}
                        </>
                    );
                } else if (type === 'Thesis' || type === 'Dissertation' || type === 'Research Proposal') {
                    return (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="form-label">Supervisor</label>
                                    <input type="text" name="supervisor" value={formData.supervisor} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="Dr. Supervisor" />
                                </div>
                                <div>
                                    <label className="form-label">Co-Supervisor (Optional)</label>
                                    <input type="text" name="coSupervisor" value={formData.coSupervisor} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="Prof. Co-Supervisor" />
                                </div>
                            </div>
                        </>
                    );
                } else if (type === 'Internship Report') {
                    return (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="form-label">Academic Supervisor</label>
                                    <input type="text" name="academicSupervisor" value={formData.academicSupervisor} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="Dr. Academic Supervisor" />
                                </div>
                                <div>
                                    <label className="form-label">Field Supervisor</label>
                                    <input type="text" name="fieldSupervisor" value={formData.fieldSupervisor} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="Mr./Ms. Field Supervisor" />
                                </div>
                                <div>
                                    <label className="form-label">Level</label>
                                    <div className="relative">
                                        <select name="level" value={formData.level} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 pr-8 text-teal focus:border-teal outline-none appearance-none cursor-pointer text-base">
                                            <option value="300 Level" className="bg-ocean-dark text-white">300 Level</option>
                                            <option value="400 Level" className="bg-ocean-dark text-white">400 Level</option>
                                            <option value="500 Level" className="bg-ocean-dark text-white">500 Level</option>
                                            <option value="Others" className="bg-ocean-dark text-white">Others</option>
                                        </select>
                                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-teal">
                                            <Icons.ChevronDown />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Custom Level Input for Thesis/Dissertation */}
                            {formData.level === "Others" && (
                                <div>
                                    <label className="form-label">Enter Level</label>
                                    <input 
                                        type="text" 
                                        name="levelCustom" 
                                        value={formData.levelCustom || ''} 
                                        onChange={handleInputChange} 
                                        className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" 
                                        placeholder="e.g., Masters, PhD, Post-Doctoral, etc." 
                                    />
                                </div>
                            )}
                        </>
                    );
                }
                return null;
            };

            return (
                <div className="max-w-4xl mx-auto">
                    <div className="glass-panel rounded-xl p-4 md:p-6">
                        <h2 className="text-xl md:text-2xl font-bold text-white mb-4 md:mb-6 flex items-center gap-3 font-display border-b border-white/10 pb-3 md:pb-4">
                            Provide Cover Page info
                        </h2>

                        <div className="space-y-4">
                            {/* Document Type */}
                            <div>
                                <label className="form-label">Document Type *</label>
                                <div className="relative">
                                    <select name="documentType" value={formData.documentType} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 pr-8 text-teal focus:border-teal outline-none appearance-none cursor-pointer text-base">
                                        <option value="Assignment" className="bg-ocean-dark text-white">Assignment</option>
                                        <option value="Internship Report" className="bg-ocean-dark text-white">Internship Report</option>
                                        <option value="Thesis" className="bg-ocean-dark text-white">Thesis / Dissertation</option>
                                        <option value="Research Proposal" className="bg-ocean-dark text-white">Research Proposal</option>
                                    </select>
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-teal">
                                        <Icons.ChevronDown />
                                    </div>
                                </div>
                            </div>



                            {/* Institution & Faculty */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="form-label">Institution *</label>
                                    <div className="relative">
                                        <select name="institution" value={formData.institution} onChange={handleInstitutionChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 pr-8 text-teal focus:border-teal outline-none appearance-none cursor-pointer text-base">
                                            <option value="" className="bg-ocean-dark text-white">Select Institution</option>
                                            {institutions.map(inst => (
                                                <option key={inst.id} value={inst.id} className="bg-ocean-dark text-white">{inst.name}</option>
                                            ))}
                                        </select>
                                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-teal">
                                            <Icons.ChevronDown />
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="form-label">Faculty/School *</label>
                                    <div className="relative">
                                        <select name="faculty" value={formData.faculty} onChange={handleFacultyChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 pr-8 text-teal focus:border-teal outline-none appearance-none cursor-pointer text-base" disabled={!formData.institution}>
                                            <option value="" className="bg-ocean-dark text-white">Select Faculty</option>
                                            {faculties.map(fac => (
                                                <option key={fac.name} value={fac.name} className="bg-ocean-dark text-white">{fac.name}</option>
                                            ))}
                                            <option value="Others" className="bg-ocean-dark text-white">Others</option>
                                        </select>
                                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-teal">
                                            <Icons.ChevronDown />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Institution Request Form - only show when no institution is selected */}
                            {!formData.institution && <div className="bg-blue-500/10 border border-blue-400/30 rounded-lg p-4">
                                {showInstitutionThankYou ? (
                                    <div className="text-center space-y-4">
                                        <div className="flex justify-center">
                                            <div className="bg-green-500/20 p-3 rounded-full">
                                                <Icons.CheckCircle className="text-green-400" size={32} />
                                            </div>
                                        </div>
                                        <div>
                                            <p className="text-lg font-semibold text-white mb-2">Thank you for your request!</p>
                                            <p className="text-sm text-blue-200">
                                                We'll notify you when your school's cover page is added. In the meantime, continue using AfroDocs!
                                            </p>
                                        </div>
                                        <a 
                                            href="https://chat.whatsapp.com/CrSrujvvZj41FNvIWbkJoG?mode=gi_t"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="inline-flex items-center gap-2 px-4 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-300 hover:text-green-200 rounded-lg text-sm font-medium transition-colors border border-green-400/30 hover:border-green-400/50"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                            </svg>
                                            Join our Community
                                        </a>
                                        <button
                                            onClick={() => setShowInstitutionThankYou(false)}
                                            className="block mx-auto text-xs text-mist hover:text-white transition-colors mt-2"
                                        >
                                            Request another institution
                                        </button>
                                    </div>
                                ) : (
                                    <>
                                        <p className="text-sm text-blue-200 mb-4 font-semibold">
                                            Don't see your institution? Request it to be added!
                                        </p>
                                        <form 
                                            onSubmit={async (e) => {
                                                e.preventDefault();
                                                try {
                                                    const res = await fetch(`${API_BASE}/api/institution-requests`, {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ institution_name: institutionRequest }),
                                                        credentials: 'include'
                                                    });
                                                    const data = await res.json();
                                                    if (res.ok) {
                                                        setInstitutionRequest('');
                                                        setShowInstitutionThankYou(true);
                                                    } else {
                                                        setInstitutionRequestMessage(data.message || 'Error submitting request');
                                                        setTimeout(() => setInstitutionRequestMessage(''), 3000);
                                                    }
                                                } catch (err) {
                                                    setInstitutionRequestMessage('Error submitting request');
                                                    console.error(err);
                                                    setTimeout(() => setInstitutionRequestMessage(''), 3000);
                                                }
                                            }}
                                            className="flex flex-col sm:flex-row gap-2"
                                        >
                                            <input
                                                type="text"
                                                value={institutionRequest}
                                                onChange={(e) => setInstitutionRequest(e.target.value)}
                                                placeholder="Enter institution name..."
                                                required
                                                className="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white text-sm placeholder-white/30 focus:border-blue-400 focus:outline-none"
                                            />
                                            <button
                                                type="submit"
                                                disabled={loading || !institutionRequest.trim()}
                                                className="px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 hover:text-blue-200 rounded-lg text-sm font-medium transition-colors border border-blue-400/20 hover:border-blue-400/50 disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                Request
                                            </button>
                                        </form>
                                        {institutionRequestMessage && (
                                            <p className="text-xs text-blue-300 mt-2">{institutionRequestMessage}</p>
                                        )}
                                    </>
                                )}
                            </div>}

                            {/* Custom Faculty Input */}
                            {formData.faculty === "Others" && (
                                <div>
                                    <label className="form-label">Enter Faculty/School Name</label>
                                    <input 
                                        type="text" 
                                        name="facultyCustom" 
                                        value={formData.facultyCustom || ''} 
                                        onChange={handleInputChange} 
                                        className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" 
                                        placeholder="Enter your faculty/school name" 
                                    />
                                </div>
                            )}

                            {/* Department & Course */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className={['Assignment'].includes(formData.documentType) ? "" : "md:col-span-2"}>
                                    <label className="form-label">Department *</label>
                                    <div className="relative">
                                        <select name="department" value={formData.department} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 pr-8 text-teal focus:border-teal outline-none appearance-none cursor-pointer text-base" disabled={!formData.faculty}>
                                            <option value="" className="bg-ocean-dark text-white">Select Department</option>
                                            {departments.map(dept => (
                                                <option key={dept} value={dept} className="bg-ocean-dark text-white">{dept}</option>
                                            ))}
                                            <option value="Others" className="bg-ocean-dark text-white">Others</option>
                                        </select>
                                        <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-teal">
                                            <Icons.ChevronDown />
                                        </div>
                                    </div>
                                </div>
                                {['Assignment'].includes(formData.documentType) && (
                                    <div className="relative">
                                        <label className="form-label">Course Code</label>
                                        <input 
                                            type="text" 
                                            name="courseCode" 
                                            value={formData.courseCode} 
                                            onChange={handleCourseCodeChange} 
                                            className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" 
                                            placeholder="e.g. COMP301"
                                            autoComplete="off"
                                        />
                                        {courseSuggestions.length > 0 && (
                                            <div className="absolute z-10 w-full bg-ocean-dark border border-slate rounded-lg mt-2 shadow-2xl max-h-48 overflow-y-auto p-2">
                                                {courseSuggestions.map(course => (
                                                    <div 
                                                        key={course.code} 
                                                        className="p-2 hover:bg-ocean rounded-md cursor-pointer text-teal text-sm transition-colors"
                                                        onClick={() => {
                                                            setFormData(prev => ({ ...prev, courseCode: course.code, courseTitle: course.title }));
                                                            setCourseSuggestions([]);
                                                        }}
                                                    >
                                                        <span className="font-bold">{course.code}</span> - {course.title}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Custom Department Input */}
                            {formData.department === "Others" && (
                                <div>
                                    <label className="form-label">Enter Department Name</label>
                                    <input 
                                        type="text" 
                                        name="departmentCustom" 
                                        value={formData.departmentCustom || ''} 
                                        onChange={handleInputChange} 
                                        className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" 
                                        placeholder="Enter your department name" 
                                    />
                                </div>
                            )}

                            {/* Course Title & Assignment Title */}
                            {['Assignment'].includes(formData.documentType) && (
                                <div>
                                    <label className="form-label">Course Title</label>
                                    <input type="text" name="courseTitle" value={formData.courseTitle} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="Data Structures and Algorithms" />
                                </div>
                            )}
                            <div>
                                <label className="form-label">Title *</label>
                                <input type="text" name="title" value={formData.title} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="e.g. Binary Search Tree Implementation" />
                            </div>

                            {/* Dynamic Fields */}
                            {renderDynamicFields()}

                            {/* Student Info */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="form-label">Student Name *</label>
                                    <input type="text" name="studentName" value={formData.studentName} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="John Doe" />
                                </div>
                                <div>
                                    <label className="form-label">Matriculation Number *</label>
                                    <input type="text" name="studentId" value={formData.studentId} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" placeholder="FE21A001" />
                                </div>
                            </div>

                            {/* Date */}
                            <div>
                                <label className="form-label">Submission Date</label>
                                <input type="date" name="date" value={formData.date} onChange={handleInputChange} className="w-full glass-input rounded-lg p-2 md:p-2.5 text-white placeholder-white/30 focus:border-teal outline-none text-base" />
                            </div>

                            {/* Actions */}
                            <div className="flex gap-4 pt-4">
                                <button 
                                    onClick={handleSubmit} 
                                    disabled={loading}
                                    className="flex-1 bg-gradient-to-r from-ocean to-teal text-white py-2 md:py-3 rounded-lg font-semibold text-base shadow-lg shadow-ocean/30 hover:shadow-ocean/50 hover:scale-[1.01] hover:from-ocean-dark hover:to-ocean transition-all disabled:opacity-50 disabled:hover:scale-100"
                                >
                                    {loading ? 'Creating...' : 'Create Cover Page'}
                                </button>
                            </div>

                            {/* Result */}
                            {generatedFile && (
                                <div className="mt-6 bg-teal/10 border border-teal/30 rounded-xl p-3 md:p-4 flex flex-col gap-4 backdrop-blur-sm">
                                    <div className="flex items-center gap-2 md:gap-3">
                                        <div className="bg-teal/20 p-1.5 rounded-full">
                                            <span className="text-teal"><Icons.CheckCircle /></span>
                                        </div>
                                        <span className="text-teal-light font-medium text-sm md:text-base">
                                            {mergeJobId ? 'Cover Page + Document Generated!' : `${generatedFile.filename} generated!`}
                                        </span>
                                    </div>
                                    
                                    <div className="flex flex-col gap-3">
                                        <div className="grid grid-cols-2 gap-3">
                                            <button 
                                                onClick={() => {
                                                    const downloadUrl = `${API_BASE}${generatedFile.downloadUrl}?inline=false`;
                                                    const link = document.createElement('a');
                                                    link.href = downloadUrl;
                                                    link.download = ''; 
                                                    document.body.appendChild(link);
                                                    link.click();
                                                    document.body.removeChild(link);
                                                }}
                                                className="flex items-center justify-center gap-2 bg-teal hover:bg-teal-light text-white px-3 py-2 rounded-lg text-sm md:text-base font-bold shadow-lg shadow-teal/20 transition-all hover:-translate-y-0.5 text-center w-full"
                                            >
                                                <span className="scale-75 md:scale-100"><Icons.Download /></span>
                                                Download DOCX
                                            </button>
                                            <button 
                                                onClick={async () => {
                                                    // Use URL-based filename for robust handling
                                                    const pdfFilename = generatedFile.filename ? generatedFile.filename.replace(/\.docx$/i, '.pdf') : 'formatted_document.pdf';
                                                    const downloadUrl = `${API_BASE}/download-pdf/${generatedFile.job_id}/${encodeURIComponent(pdfFilename)}?inline=false`;
                                                    
                                                    try {
                                                        const response = await fetch(downloadUrl);
                                                        if (!response.ok) throw new Error('Download failed');
                                                        
                                                        const link = document.createElement('a');
                                                        link.href = downloadUrl;
                                                        link.download = pdfFilename;
                                                        document.body.appendChild(link);
                                                        link.click();
                                                        document.body.removeChild(link);
                                                    } catch (err) {
                                                        console.error(err);
                                                        alert('Download failed');
                                                    }
                                                }}
                                                className="flex items-center justify-center gap-2 bg-teal hover:bg-teal-light text-white px-3 py-2 rounded-lg text-sm md:text-base font-bold shadow-lg shadow-teal/20 transition-all hover:-translate-y-0.5 text-center w-full"
                                            >
                                                <span className="scale-75 md:scale-100"><Icons.Download /></span>
                                                Download PDF
                                            </button>
                                        </div>

                                        {/* Inline Preview - Responsive for all devices */}
                                        <div className="glass-panel rounded-xl overflow-hidden h-[300px] sm:h-[400px] md:h-[600px] flex flex-col border border-teal/30 shadow-2xl mt-4">
                                            <div className="flex items-center justify-between border-b border-white/10 bg-black/20 p-2 sm:p-3 md:p-4">
                                                <div className="font-bold text-white flex items-center gap-1 sm:gap-2 text-sm sm:text-base md:text-lg">
                                                    <span className="text-teal scale-75 sm:scale-90 md:scale-100"><Icons.Eye /></span>
                                                    <span className="hidden sm:inline">Document</span> Preview
                                                </div>
                                                <button
                                                    onClick={() => setShowPdfModal(true)}
                                                    className="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1 sm:py-2 bg-white/5 text-mist hover:text-white hover:bg-white/10 rounded-lg transition-all duration-300 border border-white/10 hover:border-white/30 text-xs sm:text-sm"
                                                    title="Full Screen"
                                                >
                                                    <Icons.Maximize className="scale-75 sm:scale-90 md:scale-100" />
                                                    <span className="hidden sm:inline">Full Screen</span>
                                                </button>
                                            </div>

                                            <div className="flex-1 relative bg-slate-900">
                                                { loading ? (
                                                    <div className="absolute inset-0 flex items-center justify-center z-10 bg-slate-900/60 backdrop-blur-sm">
                                                                                        <div className="flex items-center justify-center h-full text-mist flex-col gap-4">
                                                                                            <div className="lightning-loading">
                                                                                                <Icons.Zap />
                                                                                            </div>
                                                                                            <p className="text-sm sm:text-base">Generating preview...</p>
                                                                                        </div>
                                                    </div>
                                                                                ) : pdfPreviewUrl ? (
                                                    <>
                                                        {/* Mobile PDF.js viewer */}
                                                        <div className="md:hidden h-full">
                                                            <MobilePdfViewer pdfUrl={pdfPreviewUrl} maxHeight={350} />
                                                        </div>
                                                        {/* Desktop iframe preview */}
                                                        <iframe 
                                                            src={`${pdfPreviewUrl}#toolbar=0&navpanes=0&scrollbar=0&view=FitV`}
                                                            className="w-full h-full border-0 hidden md:block"
                                                            title="PDF Preview"
                                                        />
                                                    </>
                                                ) : (
                                                    <div className="flex items-center justify-center h-full text-mist flex-col gap-4">
                                                        <div className="lightning-loading">
                                                            <Icons.Zap />
                                                        </div>
                                                        <p className="text-sm sm:text-base">Loading preview...</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Document Preview Component
        const DocumentPreview = ({ data }) => {
            if (!data || data.length === 0) {
                return (
                    <div className="text-center text-mist p-12 bg-black/20 rounded-xl border border-white/5">
                        <p>No preview data available.</p>
                    </div>
                );
            }

            return (
                <>
                <div className="document-preview-note">
                    Preview may vary on mobile depending on your document viewer. Table of contents appears on PC.
                </div>
                <div className="document-preview-container custom-scrollbar">
                    <div className="document-page">
                        {data.map((section, idx) => (
                            <div key={idx} className="section-block">
                                {/* Heading */}
                                {section.heading && section.heading !== 'Untitled' && (
                                    section.level === 1 ? (
                                        <h1>{section.heading}</h1>
                                    ) : (
                                        <div className={`font-bold text-left mb-3 mt-4 text-[12pt]`}>
                                            {section.heading}
                                        </div>
                                    )
                                )}

                                {/* Content */}
                                {section.content && section.content.map((item, i) => {
                                    // Paragraph
                                    if (item.type === 'paragraph') {
                                        return <p key={i} className="mb-0">{item.text}</p>;
                                    }
                                    
                                    // Block Quote
                                    if (item.type === 'block_quote') {
                                        return <p key={i} className="block-quote">{item.text.replace(/^[>\s]+/, '')}</p>;
                                    }

                                    // Abbreviation
                                    if (item.type === 'abbreviation') {
                                        const match = item.text.match(/([A-Z]{2,})\s*[-â€“:=]\s*(.+)/);
                                        if (match) {
                                            return (
                                                <p key={i} className="mb-0">
                                                    <strong>{match[1]}</strong> â€“ {match[2]}
                                                </p>
                                            );
                                        }
                                        return <p key={i} className="mb-0">{item.text}</p>;
                                    }

                                    // Copyright
                                    if (item.type === 'copyright_content') {
                                        return <p key={i} className="text-center italic mb-0">{item.text}</p>;
                                    }

                                    // Signature Line
                                    if (item.type === 'signature_line') {
                                        return (
                                            <p key={i} className="text-right mt-8 mb-0">
                                                {item.text || '________________________'}
                                            </p>
                                        );
                                    }

                                    // Running Header
                                    if (item.type === 'running_header') {
                                        return <p key={i} className="text-center text-gray-500 mb-4 text-sm">{item.text}</p>;
                                    }

                                    // Math
                                    if (item.type === 'math_expression' || item.type === 'math_model') {
                                        const isDisplay = item.subtype === 'display_math' || item.type === 'math_model';
                                        const cleanText = item.text.replace(/^\$\$|\$\$$|^\$|\$$|^\\\[|\\\]$|^\\\(|\\\)$/g, '');
                                        return (
                                            <p key={i} className={isDisplay ? "math-display" : "mb-0"}>
                                                {cleanText}
                                            </p>
                                        );
                                    }

                                    // Footnote / Glossary
                                    if (item.type === 'footnote_entry' || item.type === 'footnote_endnote') {
                                        return <p key={i} className="hanging-indent">{item.text}</p>;
                                    }
                                    if (item.type === 'glossary_entry') {
                                        return (
                                            <p key={i} className="glossary-indent">
                                                {item.term ? <strong>{item.term}: </strong> : null}
                                                {item.definition || item.text}
                                            </p>
                                        );
                                    }
                                    
                                    // Definition (Legacy)
                                    if (item.type === 'definition') {
                                        return (
                                            <p key={i} className="glossary-indent">
                                                <strong>{item.term}:</strong> {item.definition}
                                            </p>
                                        );
                                    }
                                    
                                    // Lists
                                    if (item.type === 'bullet_list') {
                                        return (
                                            <ul key={i} className="document-list list-disc mb-4">
                                                {item.items.map((li, l) => {
                                                    // Handle both string items and object items (enhanced bullets)
                                                    const content = typeof li === 'object' && li !== null 
                                                        ? (li.content || li.text || JSON.stringify(li)) 
                                                        : li;
                                                    return <li key={l} className="document-list-item">{content}</li>;
                                                })}
                                            </ul>
                                        );
                                    }
                                    if (item.type === 'numbered_list') {
                                        return (
                                            <ol key={i} className="document-list list-decimal mb-4">
                                                {item.items.map((li, l) => {
                                                    // Handle both string items and object items
                                                    const content = typeof li === 'object' && li !== null 
                                                        ? (li.content || li.text || JSON.stringify(li)) 
                                                        : li;
                                                    return <li key={l} className="document-list-item">{content}</li>;
                                                })}
                                            </ol>
                                        );
                                    }

                                    // Key Points (Warning, Note, etc.)
                                    if (item.type === 'key_point') {
                                        const isExample = item.key_point_type === 'example';
                                        return (
                                            <p key={i} className={`my-2 ${isExample ? 'italic' : 'font-bold'}`}>
                                                {item.emoji_prefix} {item.text}
                                            </p>
                                        );
                                    }

                                    // Captions
                                    if (item.type === 'caption_format' || item.type === 'figure_equation') {
                                        // Check if it's a figure or table caption based on text content
                                        const isTable = /^(Table|Tbl)/i.test(item.text);
                                        return (
                                            <p key={i} className={isTable ? "table-caption" : "figure-caption"}>
                                                {item.text}
                                            </p>
                                        );
                                    }

                                    // Tables
                                    if (item.type === 'table' || (item.rows && item.rows.length > 0)) {
                                        return (
                                            <div key={i} className="mb-4">
                                                {item.caption && <p className="table-caption">{item.caption}</p>}
                                                <table style={{lineHeight: '1.0'}}>
                                                    <tbody>
                                                        {item.rows.map((row, r) => (
                                                            <tr key={r}>
                                                                {row.map((cell, c) => (
                                                                    r === 0 ? <th key={c}>{cell}</th> : <td key={c}>{cell}</td>
                                                                ))}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        );
                                    }

                                    return null;
                                })}
                            </div>
                        ))}
                    </div>
                </div>
                </>
            );
        };

        // Formatting Options Modal Component
        const FormattingOptionsModal = ({ isOpen, onClose, onApply, options, setOptions }) => {
            if (!isOpen) return null;

            const handleApply = () => {
                onApply(options);
            };

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-midnight border border-teal/30 rounded-xl w-full max-w-sm shadow-2xl">
                        <div className="p-4 border-b border-teal/20 flex justify-between items-center">
                            <h2 className="text-lg font-bold text-white">Formatting</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <Icons.X size={20} />
                            </button>
                        </div>
                        
                        <div className="p-4 space-y-4">
                            {/* TOC Toggle */}
                            <label className="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity">
                                <input
                                    type="checkbox"
                                    checked={options.includeTOC}
                                    onChange={(e) => setOptions({...options, includeTOC: e.target.checked})}
                                    className="w-4 h-4 cursor-pointer accent-teal"
                                />
                                <span className="text-white text-sm">Include Table of Contents</span>
                            </label>
                            {/* Font Size - Compact */}
                            <div className="flex items-center justify-between gap-2">
                                <label className="text-white text-sm w-24">Font Size</label>
                                <select
                                    value={options.fontSize}
                                    onChange={(e) => setOptions({...options, fontSize: e.target.value})}
                                    className="flex-1 glass-input rounded-lg p-2 text-white text-sm focus:border-teal outline-none"
                                >
                                    <option value="10">10pt</option>
                                    <option value="11">11pt</option>
                                    <option value="12">12pt</option>
                                    <option value="14">14pt</option>
                                    <option value="16">16pt</option>
                                </select>
                            </div>

                            {/* Line Spacing - Compact */}
                            <div className="flex items-center justify-between gap-2">
                                <label className="text-white text-sm w-24">Spacing</label>
                                <select
                                    value={options.lineSpacing}
                                    onChange={(e) => setOptions({...options, lineSpacing: e.target.value})}
                                    className="flex-1 glass-input rounded-lg p-2 text-white text-sm focus:border-teal outline-none"
                                >
                                    <option value="1.0">1.0</option>
                                    <option value="1.15">1.15</option>
                                    <option value="1.5">1.5</option>
                                    <option value="2.0">2.0</option>
                                </select>
                            </div>

                            {/* Margins Toggle Section */}
                            <div className="space-y-2">
                                <div className="flex items-center justify-between gap-2">
                                    <label className="text-white text-sm w-24">Margins</label>
                                    <button
                                        onClick={() => setOptions({
                                            ...options, 
                                            useIndividualMargins: !options.useIndividualMargins
                                        })}
                                        className="text-xs px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-teal transition-colors font-medium"
                                    >
                                        {options.useIndividualMargins ? 'Customize margins' : 'Customize margins'}
                                    </button>
                                </div>

                                {!options.useIndividualMargins ? (
                                    <input
                                        type="number"
                                        value={options.marginCm}
                                        onChange={(e) => setOptions({...options, marginCm: e.target.value})}
                                        min="0.5"
                                        max="5"
                                        step="0.5"
                                        className="w-full glass-input rounded-lg p-2 text-white text-sm focus:border-teal outline-none"
                                        placeholder="2.5 cm"
                                    />
                                ) : (
                                    <div className="grid grid-cols-4 gap-1.5">
                                        <div className="flex flex-col">
                                            <input
                                                type="number"
                                                value={options.marginLeft}
                                                onChange={(e) => setOptions({...options, marginLeft: e.target.value})}
                                                min="0.5"
                                                max="5"
                                                step="0.5"
                                                className="glass-input rounded p-2 text-white text-xs focus:border-teal outline-none text-center"
                                                placeholder="L"
                                                title="Left"
                                            />
                                            <label className="text-white text-xs text-center mt-1">Left</label>
                                        </div>
                                        <div className="flex flex-col">
                                            <input
                                                type="number"
                                                value={options.marginTop}
                                                onChange={(e) => setOptions({...options, marginTop: e.target.value})}
                                                min="0.5"
                                                max="5"
                                                step="0.5"
                                                className="glass-input rounded p-2 text-white text-xs focus:border-teal outline-none text-center"
                                                placeholder="T"
                                                title="Top"
                                            />
                                            <label className="text-white text-xs text-center mt-1">Top</label>
                                        </div>
                                        <div className="flex flex-col">
                                            <input
                                                type="number"
                                                value={options.marginBottom}
                                                onChange={(e) => setOptions({...options, marginBottom: e.target.value})}
                                                min="0.5"
                                                max="5"
                                                step="0.5"
                                                className="glass-input rounded p-2 text-white text-xs focus:border-teal outline-none text-center"
                                                placeholder="B"
                                                title="Bottom"
                                            />
                                            <label className="text-white text-xs text-center mt-1">Bottom</label>
                                        </div>
                                        <div className="flex flex-col">
                                            <input
                                                type="number"
                                                value={options.marginRight}
                                                onChange={(e) => setOptions({...options, marginRight: e.target.value})}
                                                min="0.5"
                                                max="5"
                                                step="0.5"
                                                className="glass-input rounded p-2 text-white text-xs focus:border-teal outline-none text-center"
                                                placeholder="R"
                                                title="Right"
                                            />
                                            <label className="text-white text-xs text-center mt-1">Right</label>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Action Buttons */}
                            <div className="flex gap-2 pt-3">
                                <button
                                    onClick={onClose}
                                    className="flex-1 px-4 py-2 bg-white/5 text-white text-sm rounded-lg hover:bg-white/10 transition-colors font-medium"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleApply}
                                    className="flex-1 px-4 py-2 bg-gradient-to-r from-ocean to-teal text-white text-sm rounded-lg hover:from-ocean-dark hover:to-ocean transition-all duration-300 font-medium"
                                >
                                    Process
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Pricing Modal Component
        const PricingModal = ({ isOpen, onClose, onSelectPlan, limitReached }) => {
            if (!isOpen) return null;

            const plans = [
                {
                    id: 'student',
                    name: 'Student',
                    price: '1,000',
                    amount: 1000,
                    pages: '500 pages',
                    validity: '2 months'
                },
                {
                    id: 'campus',
                    name: 'Campus Pro',
                    price: '2,500',
                    amount: 2500,
                    pages: '1,500 pages',
                    validity: '2 months',
                    popular: true
                },
                {
                    id: 'enterprise',
                    name: 'Enterprise',
                    price: '5,000',
                    amount: 5000,
                    pages: '10,000 pages',
                    validity: '2 months'
                }
            ];

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-3">
                    <div className="bg-[#0a1929] border border-teal/20 rounded-xl w-full max-w-md shadow-2xl">
                        <div className="p-4 border-b border-teal/10 flex justify-between items-center">
                            <h2 className="text-lg font-bold text-white">Choose Your Plan</h2>
                            <button onClick={onClose} className="text-mist hover:text-white transition-colors p-1">
                                <Icons.X size={20} />
                            </button>
                        </div>
                        
                        {limitReached && (
                            <div className="mx-3 mt-3 p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                                <p className="text-red-400 text-sm text-center font-medium">
                                    Free tier limit reached (300 pages/month). Please subscribe to continue.
                                </p>
                            </div>
                        )}
                        
                        <div className="p-3 space-y-2">
                            {plans.map(plan => (
                                <div 
                                    key={plan.id} 
                                    className={`bg-[#0d2137] border rounded-lg p-3 transition-all relative ${plan.popular ? 'border-teal' : 'border-white/10 hover:border-teal/50'}`}
                                >
                                    {plan.popular && (
                                        <div className="absolute -top-2 right-3 bg-teal text-[#0a1929] text-[9px] font-bold px-2 py-0.5 rounded">BEST VALUE</div>
                                    )}
                                    <div className="flex items-center justify-between">
                                        <div className="flex-1">
                                            <div className="flex items-baseline gap-2">
                                                <span className="text-white font-bold">{plan.name}</span>
                                                <span className="text-teal font-bold text-lg">{plan.price} <span className="text-xs text-mist">FCFA</span></span>
                                            </div>
                                            <div className="text-xs text-mist mt-0.5">{plan.pages} â€¢ {plan.validity}</div>
                                        </div>
                                        <button
                                            onClick={() => onSelectPlan(0, plan.amount)}
                                            className="px-4 py-2 bg-gradient-to-r from-[#1E5A8E] to-teal text-white rounded-lg text-xs font-bold hover:opacity-90 transition-all"
                                        >
                                            Subscribe
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="p-3 pt-0">
                            <p className="text-center text-mist text-[10px]">All plans include no watermark â€¢ Secure payment</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Main Application Component
        const PatternDocFormatter = () => {
            const [viewMode, setViewMode] = useState(null); // null, 'formatter', 'coverpage', or 'ai'
            const [appSidebarOpen, setAppSidebarOpen] = useState(true); // Mobile sidebar state
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false); // Collapse sidebar to icons only
            const [userDocuments, setUserDocuments] = useState(() => {
                const saved = localStorage.getItem('afrodocs_user_documents');
                return saved ? JSON.parse(saved) : [];
            });
            const [renameDoc, setRenameDoc] = useState(null);
            const [renameValue, setRenameValue] = useState('');
            const [renameError, setRenameError] = useState('');
            const [renameSubmitting, setRenameSubmitting] = useState(false);
            const [file, setFile] = useState(null);
            const [processing, setProcessing] = useState(false);
            const [progress, setProgress] = useState(0);
            const [status, setStatus] = useState('');
            const [result, setResult] = useState(null);
            const [preview, setPreview] = useState(null);
            const [error, setError] = useState(null);
            const errorIsPositive = error && /account created|already created|please log in|success/i.test(error);
            const [dragOver, setDragOver] = useState(false);
            const [activeTab, setActiveTab] = useState('preview');
            const [mergeJobId, setMergeJobId] = useState(null);
            const [pastedText, setPastedText] = useState('');
            const [isRestructuringPaste, setIsRestructuringPaste] = useState(false);
            const [showSuccessMessage, setShowSuccessMessage] = useState(false);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [showShare, setShowShare] = useState(false);
            const [showProfile, setShowProfile] = useState(false);
            const fileInputRef = useRef(null);
            const [shareBlob, setShareBlob] = useState(null);
            const [pdfPreviewUrl, setPdfPreviewUrl] = useState(null);
            const [showPdfModal, setShowPdfModal] = useState(false);
            const [pdfViewParam, setPdfViewParam] = useState('FitH');
            const [coverpageOpening, setCoverpageOpening] = useState(false);
            const abortControllerRef = useRef(null);
            const [pdfPreviewError, setPdfPreviewError] = useState(false);
            const [pdfPreviewLoading, setPdfPreviewLoading] = useState(true);
            const [pdfPreviewKey, setPdfPreviewKey] = useState(0);
            const [showPricingModal, setShowPricingModal] = useState(false);
            const [pricingLimitReached, setPricingLimitReached] = useState(false);
            const [showSupportModal, setShowSupportModal] = useState(false);
            const [supportForm, setSupportForm] = useState({ name: '', email: '', subject: '', message: '' });
            const [supportSubmitting, setSupportSubmitting] = useState(false);
            const [supportStatus, setSupportStatus] = useState('');
            const [deferredInstallPrompt, setDeferredInstallPrompt] = useState(null);
            const [canInstall, setCanInstall] = useState(false);
            const [isIosDevice, setIsIosDevice] = useState(false);
            const [isInstalled, setIsInstalled] = useState(false);
            const [updateAvailable, setUpdateAvailable] = useState(false);
            const [serviceWorkerRegistration, setServiceWorkerRegistration] = useState(null);
            const [supportError, setSupportError] = useState('');
            // AI Assistant state
            const [showAiAssistant, setShowAiAssistant] = useState(false);
            const [aiSidebarOpen, setAiSidebarOpen] = useState(true);
            // Documents expansion state
            const [showAllDocuments, setShowAllDocuments] = useState(false);
            // Payment success modal state
            const [showPaymentSuccessModal, setShowPaymentSuccessModal] = useState(false);
            // Formatting options states
            const [showFormattingModal, setShowFormattingModal] = useState(false);
            const [pendingFile, setPendingFile] = useState(null);
            const RESTRUCTURE_PASTE_MAX_CHARS = 6000;
            const isPastedTextWithinAiLimit = pastedText.trim().length > 0
                && pastedText.length <= RESTRUCTURE_PASTE_MAX_CHARS;
            const defaultFormattingOptions = {
                includeTOC: false,
                fontSize: '12',
                lineSpacing: '1.5',
                marginCm: '2.5',
                useIndividualMargins: false,
                marginLeft: '3.0',
                marginTop: '2.5',
                marginBottom: '2.5',
                marginRight: '2.5'
            };
            const [formattingOptions, setFormattingOptions] = useState(defaultFormattingOptions);

            const handleUpgrade = async (pages, amount) => {
                setShowPricingModal(false);
                try {
                    const response = await fetch(`${API_BASE}/api/payment/initiate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ amount, pages })
                    });
                    const data = await response.json();
                    if (data.link) {
                        window.location.href = data.link;
                    } else {
                        setError(data.message || 'Failed to initiate payment');
                    }
                } catch (err) {
                    setError('Payment error: ' + err.message);
                }
            };

            const handleInstallClick = async () => {
                if (updateAvailable) {
                    setUpdateAvailable(false);
                    if (serviceWorkerRegistration) {
                        serviceWorkerRegistration.update();
                    }
                    window.location.reload();
                    return;
                }
                if (deferredInstallPrompt) {
                    deferredInstallPrompt.prompt();
                    const choice = await deferredInstallPrompt.userChoice;
                    if (choice.outcome === 'accepted') {
                        setCanInstall(false);
                        setDeferredInstallPrompt(null);
                    }
                } else if (isIosDevice) {
                    alert('To install AfroDocs, tap Share and choose "Add to Home Screen".');
                } else {
                    alert('Install is not available right now. Please try again later.');
                }
            };

            useEffect(() => {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const ios = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
                setIsIosDevice(ios);

                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
                setIsInstalled(Boolean(isStandalone));

                const handleBeforeInstallPrompt = (event) => {
                    event.preventDefault();
                    setDeferredInstallPrompt(event);
                    setCanInstall(true);
                };

                const handleAppInstalled = () => {
                    setIsInstalled(true);
                    setCanInstall(false);
                    setDeferredInstallPrompt(null);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                window.addEventListener('appinstalled', handleAppInstalled);

                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then((registration) => {
                            setServiceWorkerRegistration(registration);
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                if (!newWorker) return;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        setUpdateAvailable(true);
                                    }
                                });
                            });
                        })
                        .catch((err) => {
                            console.warn('Service worker registration failed', err);
                        });
                }

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                    window.removeEventListener('appinstalled', handleAppInstalled);
                };
            }, []);

            // Check for payment success on load
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('payment') === 'success') {
                    setStatus('Verifying payment...');
                    setProcessing(true);
                    
                    fetch(`${API_BASE}/api/payment/verify-pending`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    })
                    .then(res => res.json())
                    .then(data => {
                        setProcessing(false);
                        if (data.success && data.message.includes('Verified')) {
                            setShowPaymentSuccessModal(true);
                            setStatus('');
                            // Clear URL param
                            window.history.replaceState({}, document.title, window.location.pathname);
                            // Refresh user state to get updated balance
                            fetch(`${API_BASE}/api/auth/status`, { credentials: 'include' })
                                .then(res => res.json())
                                .then(userData => {
                                    if (userData.isAuthenticated) {
                                        setCurrentUser(userData);
                                    }
                                });
                        } else {
                            setStatus('Payment verification complete.');
                        }
                    })
                    .catch(err => {
                        console.error('Verification failed', err);
                        setProcessing(false);
                    });
                }
            }, []);

            // Pre-fetch blob for sharing
            useEffect(() => {
                if (result && result.job_id) {
                    fetch(`${API_BASE}/download/${result.job_id}`, { credentials: 'include' })
                        .then(res => {
                            if (res.ok) return res.blob();
                            throw new Error('Fetch failed');
                        })
                        .then(blob => setShareBlob(blob))
                        .catch(err => console.error("Pre-fetch failed", err));
                } else {
                    setShareBlob(null);
                }
            }, [result]);

            // Timer effect
            useEffect(() => {
                let interval;
                if (processing) {
                    const startTime = Date.now();
                    interval = setInterval(() => {
                        setElapsedTime(Date.now() - startTime);
                    }, 10);
                } else {
                    setElapsedTime(0);
                }
                return () => clearInterval(interval);
            }, [processing]);

            // Stop generation handler
            const handleStopGeneration = useCallback(() => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                    abortControllerRef.current = null;
                    setProcessing(false);
                    setStatus('Generation stopped');
                    setProgress(0);
                    setError('Document generation was stopped.');
                }
            }, []);

            // Handle file selection
            const handleFileSelect = useCallback(async (selectedFile) => {
                if (!selectedFile) return;

                // Validate file type
                const validTypes = ['.txt', '.docx', '.md', '.doc'];
                const fileExt = '.' + selectedFile.name.split('.').pop().toLowerCase();
                
                if (!validTypes.includes(fileExt)) {
                    setError('Invalid file type. Please upload .txt, .docx, or .md files.');
                    return;
                }

                // Store pending file and show formatting modal
                setPendingFile(selectedFile);
                setPastedText(''); // Clear pasted text if any
                setError(null);
                setShowFormattingModal(true);
            }, []);

            // Process file after formatting options are selected
            const processFileWithOptions = async (selectedFile, options) => {
                setFile(selectedFile);
                setProcessing(true);
                setProgress(0);
                setStatus('Uploading file...');
                setResult(null);
                setPreview(null);
                setError(null);
                setShowSuccessMessage(false);
                setShowFormattingModal(false);
                setPendingFile(null);

                // Create abort controller for this request
                abortControllerRef.current = new AbortController();

                // Simulate initial progress
                let progressInterval = setInterval(() => {
                    setProgress(prev => Math.min(prev + 10, 90));
                }, 200);

                try {
                    // Create form data with formatting options
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('include_toc', String(options.includeTOC));
                    formData.append('font_size', String(options.fontSize));
                    formData.append('line_spacing', String(options.lineSpacing));
                    
                    // Add margin parameters
                    if (options.useIndividualMargins) {
                        formData.append('margin_left', String(options.marginLeft));
                        formData.append('margin_top', String(options.marginTop));
                        formData.append('margin_bottom', String(options.marginBottom));
                        formData.append('margin_right', String(options.marginRight));
                    } else {
                        formData.append('margin_cm', String(options.marginCm));
                    }

                    setStatus('Processing...');

                    // Upload to backend
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData,
                        credentials: 'include',
                        signal: abortControllerRef.current.signal
                    });

                    clearInterval(progressInterval);

                    if (!response.ok) {
                        const errorData = await response.json();
                        if (errorData.error === 'LIMIT_REACHED') {
                            setError('Free tier limit reached (300 pages/month). Please upgrade to continue.');
                            setPricingLimitReached(true);
                            setShowPricingModal(true);
                        } else {
                            throw new Error(errorData.error || 'Upload failed');
                        }
                        setProcessing(false);
                        return;
                    }

                    const data = await response.json();
                    
                    setProgress(100);
                    setStatus('Complete!');
                    setResult(data);
                    setPreview(data.preview || '');
                    setShowSuccessMessage(true);

                    // Track guest document formatting
                    if (!isAuthenticated) {
                        const newCount = guestDocumentCount + 1;
                        setGuestDocumentCount(newCount);
                        localStorage.setItem('guestDocCount', newCount.toString());
                    }

                    // Save to user documents
                    const pdfFilename = data.filename ? data.filename.replace(/\.docx$/i, '.pdf') : 'formatted_document.pdf';
                    const previewUrl = `${API_BASE}/download-pdf/${data.job_id}/${encodeURIComponent(pdfFilename)}?inline=true`;
                    
                    // Use smart_filename from backend, or original filename, or the selected file name
                    const documentName = data.smart_filename || data.original_filename || selectedFile?.name || 'Document';
                    
                    const newDoc = {
                        id: Date.now(),
                        name: documentName.replace(/\.(docx|txt|md|doc)$/i, ''), // Remove extension for cleaner display
                        result: data,
                        pdfUrl: previewUrl,
                        createdAt: new Date().toISOString()
                    };
                    
                    setUserDocuments(prev => {
                        const updated = [newDoc, ...prev.filter(d => d.id !== newDoc.id)].slice(0, 10); // Keep last 10
                        localStorage.setItem('afrodocs_user_documents', JSON.stringify(updated));
                        return updated;
                    });

                    // Check for limit warning
                    if (data.limit_reached) {
                        setError('Limit Reached! You have used all your free pages. This document was processed, but you need to upgrade to process more.');
                    }

                    // Refresh user data to update page usage
                    if (isAuthenticated) {
                        fetch(`${API_BASE}/api/auth/status`, { credentials: 'include' })
                            .then(res => res.json())
                            .then(userData => {
                                if (userData.isAuthenticated) {
                                    setCurrentUser(userData);
                                }
                            })
                            .catch(err => console.error('Failed to refresh user data:', err));
                    }

                    // Auto-open preview - reset states
                    setPdfPreviewError(false);
                    setPdfPreviewLoading(true);
                    setPdfPreviewKey(prev => prev + 1);
                    setPdfPreviewUrl(previewUrl);

                } catch (err) {
                    clearInterval(progressInterval);
                    // Check if this was an abort
                    if (err.name === 'AbortError') {
                        console.log('Request aborted by user');
                        setStatus('Generation stopped');
                        setError('Document generation was stopped.');
                    } else {
                        console.error('Upload error:', err);
                        setError(err.message || 'Failed to process document. Make sure the backend server is running.');
                        setStatus('Error occurred');
                    }
                } finally {
                    setProcessing(false);
                    abortControllerRef.current = null;
                }
            };

            const handlePayment = async (amount, planName) => {
                try {
                    setProcessing(true);
                    setStatus(`Initiating payment for ${planName}...`);
                    
                    const response = await fetch(`${API_BASE}/api/payment/initiate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify({ amount })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.link) {
                        window.location.href = data.link;
                    } else {
                        setError(data.message || 'Payment initiation failed');
                        setProcessing(false);
                    }
                } catch (err) {
                    setError('Payment error: ' + err.message);
                    setProcessing(false);
                }
            };

            const handlePasteSubmit = () => {
                if (!pastedText.trim()) return;
                
                const blob = new Blob([pastedText], { type: 'text/plain' });
                const file = new File([blob], "pasted_document.txt", { type: "text/plain" });
                
                // Store pending file and show formatting modal
                setPendingFile(file);
                setShowFormattingModal(true);
            };

            const handleRestructurePastedText = async () => {
                if (!pastedText.trim() || isRestructuringPaste) return;
                setIsRestructuringPaste(true);
                setError(null);

                try {
                    const response = await fetch(`${API_BASE}/api/ai/restructure`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ text: pastedText })
                    });

                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        throw new Error(data.error || 'Failed to restructure text');
                    }

                    setPastedText(data.response || '');
                } catch (err) {
                    setError(`Restructure failed: ${err.message}`);
                } finally {
                    setIsRestructuringPaste(false);
                }
            };

            // Handler for formatting AI-generated text
            const handleAiFormatText = (text) => {
                if (!text || !text.trim()) return;
                
                // Switch to formatter view to show processing
                setViewMode('formatter');
                
                // Create a file from the AI response text
                // Generate a timestamp-based name instead of "ai_generated_document"
                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const docName = `document_${timestamp}.txt`;
                // Post-process AI text for formatting:
                // 1) Ensure References header is uppercase and starts on its own page
                // 2) Italicize journal names inside the References block using markdown emphasis
                let processed = text;

                // Find References header (case-insensitive)
                const refMatch = processed.match(/(^|\n)(\s*)(References|REFERENCES|references)\s*:?\s*(\n|$)/i);
                if (refMatch) {
                    const start = processed.search(/\n?(References|REFERENCES|references)\s*:?\s*\n/i);
                    if (start >= 0) {
                        // Split before and after references
                        const before = processed.slice(0, start);
                        let refs = processed.slice(start);

                        // Uppercase the header
                        refs = refs.replace(/(References|REFERENCES|references)\s*:?/i, 'REFERENCES');

                        // Ensure page break before REFERENCES using form-feed (many converters honor this)
                        if (!/\f/.test(before.slice(-2))) {
                            // add a form-feed to force new page
                            refs = '\n\f\n' + refs.trim();
                        }

                        // Italicize likely journal names in each reference line by taking the text
                        // immediately after the first period (title end) up to the next comma.
                        const refLines = refs.split('\n');
                        for (let i = 0; i < refLines.length; i++) {
                            const line = refLines[i];
                            // Only attempt on non-empty lines that look like reference entries
                            if (line.trim().length > 10 && /\./.test(line)) {
                                const parts = line.split('.');
                                if (parts.length >= 3) {
                                    const title = parts[0];
                                    const journalCandidate = parts[1].trim();
                                    const rest = parts.slice(2).join('.');
                                    if (journalCandidate && journalCandidate.length > 2) {
                                        // Wrap journal candidate in markdown italics
                                        refLines[i] = `${title}. *${journalCandidate}*. ${rest}`.trim();
                                    }
                                }
                            }
                        }

                        processed = before + refLines.join('\n');
                    }
                }

                // Normalize any HTML tables (from chat rendering) back to markdown tables
                // so the formatted document preserves table positions.
                if (processed.includes('<table')) {
                    try {
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = processed;
                        const tables = wrapper.querySelectorAll('table');
                        tables.forEach(table => {
                            const rows = Array.from(table.querySelectorAll('tr'));
                            if (rows.length === 0) return;
                            const headerCells = Array.from(rows[0].querySelectorAll('th,td')).map(c => c.textContent.trim());
                            const headerLine = '|' + headerCells.join(' | ') + ' |';
                            const separatorLine = '|' + headerCells.map(() => '---').join(' | ') + ' |';
                            const bodyLines = rows.slice(1).map(r => '|' + Array.from(r.querySelectorAll('td,th')).map(c => c.textContent.trim()).join(' | ') + ' |');
                            const md = '\n\n' + headerLine + '\n' + separatorLine + '\n' + bodyLines.join('\n') + '\n\n';
                            processed = processed.replace(table.outerHTML, md);
                        });
                    } catch (e) {
                        console.error('Table normalization failed:', e);
                    }
                }

                // For inline pipe-delimited tables that lost newlines, attempt to ensure they are block-level
                // Simple heuristic: look for lines containing multiple '|' segments and force surrounding newlines
                processed = processed.replace(/\s*\|\s*([^\n]+?)\s*\|\s*/g, (m) => '\n' + m.trim() + '\n');

                const blob = new Blob([processed], { type: 'text/plain' });
                const file = new File([blob], docName, { type: "text/plain" });
                
                // Store pending file and show formatting modal
                setPendingFile(file);
                setShowFormattingModal(true);
            };

            // File input change handler
            const handleFileInputChange = (event) => {
                const selectedFile = event.target.files[0];
                handleFileSelect(selectedFile);
            };

            // Drag and drop handlers
            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                const droppedFile = e.dataTransfer.files[0];
                handleFileSelect(droppedFile);
            };

            // Download handler
            const handleDownload = async (format = 'docx') => {
                if (!result || !result.job_id) return;

                setShowSuccessMessage(false);

                if (format === 'pdf') {
                    setStatus('Converting to PDF...');
                    // Use URL-based filename for robust handling
                    const pdfFilename = result.filename ? result.filename.replace(/\.docx$/i, '.pdf') : 'formatted_document.pdf';
                    const downloadUrl = `${API_BASE}/download-pdf/${result.job_id}/${encodeURIComponent(pdfFilename)}?inline=false`;

                    try {
                        // Check if conversion works first
                        const response = await fetch(downloadUrl);
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'PDF conversion failed');
                        }
                        
                        // Trigger download using the URL which contains the filename
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = pdfFilename; 
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch (err) {
                        alert(`PDF Error: ${err.message}`);
                    } finally {
                        setStatus('');
                    }
                } else {
                    // For DOCX, standard download
                    const downloadUrl = `${API_BASE}/download/${result.job_id}?inline=false`;
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = ''; 
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            // Share handler
            const handleShare = async () => {
                if (!result || !result.job_id) return;
                
                try {
                    setStatus('Preparing to share...');
                    
                    let blob = shareBlob;
                    if (!blob) {
                        const response = await fetch(`${API_BASE}/download/${result.job_id}`, { credentials: 'include' });
                        if (!response.ok) throw new Error('Download failed');
                        blob = await response.blob();
                    }

                    const fileToShare = new File([blob], `formatted_${file?.name || 'document'}.docx`, { type: blob.type });
                    
                    if (navigator.share && navigator.canShare({ files: [fileToShare] })) {
                        await navigator.share({
                            files: [fileToShare],
                            title: 'Formatted Document',
                            text: 'Here is your formatted document from AfroDocs.'
                        });
                        setStatus('Shared successfully!');
                    } else {
                        // Fallback for desktop or unsupported browsers
                        alert('Sharing is not supported on this device/browser. The file has been downloaded.');
                    }
                } catch (err) {
                    console.error(err);
                    // Don't show error if user cancelled share
                    if (err.name !== 'AbortError' && err.name !== 'NotAllowedError') {
                        setError('Failed to share: ' + err.message);
                    }
                } finally {
                    setStatus('');
                }
            };

            // Reset handler
            const handleReset = () => {
                setFile(null);
                setProcessing(false);
                setProgress(0);
                setStatus('');
                setResult(null);
                setPreview(null);
                setError(null);
                setMergeJobId(null);
                setShowSuccessMessage(false);
                setShowShare(false);
                if (fileInputRef.current) {
                    fileInputRef.current.value = '';
                }
            };

            const persistUserDocuments = useCallback((docs) => {
                setUserDocuments(docs);
                localStorage.setItem('afrodocs_user_documents', JSON.stringify(docs));
            }, []);

            const handleRenameDocument = (doc) => {
                setRenameDoc(doc);
                setRenameValue(doc.name || '');
                setRenameError('');
            };

            const handleApplyRename = async () => {
                const nextName = renameValue.trim();
                if (!nextName) {
                    setRenameError('Please enter a document name.');
                    return;
                }
                setRenameSubmitting(true);
                setRenameError('');
                try {
                    if (isAuthenticated && renameDoc?.result?.job_id) {
                        const res = await fetch(`${API_BASE}/api/documents/${renameDoc.result.job_id}/rename`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ name: nextName })
                        });
                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.error || 'Failed to rename document');
                        }
                    }
                    const updated = userDocuments.map(doc => (
                        doc.id === renameDoc.id ? { ...doc, name: nextName } : doc
                    ));
                    persistUserDocuments(updated);
                    setRenameDoc(null);
                } catch (err) {
                    setRenameError(err.message);
                } finally {
                    setRenameSubmitting(false);
                }
            };

            const handleDeleteDocument = async (doc) => {
                const confirmDelete = window.confirm(`Delete "${doc.name}"? This action cannot be undone.`);
                if (!confirmDelete) {
                    return;
                }
                try {
                    if (isAuthenticated && doc?.result?.job_id) {
                        const res = await fetch(`${API_BASE}/api/documents/${doc.result.job_id}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.error || 'Failed to delete document');
                        }
                    }
                    const updated = userDocuments.filter(item => item.id !== doc.id);
                    persistUserDocuments(updated);
                    if (result?.job_id && doc?.result?.job_id === result.job_id) {
                        setResult(null);
                        setPreview(null);
                        setPdfPreviewUrl(null);
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            const openSupportModal = () => {
                setSupportForm({
                    name: currentUser?.username || '',
                    email: currentUser?.email || '',
                    subject: '',
                    message: ''
                });
                setSupportError('');
                setSupportStatus('');
                setShowProfile(false);
                setSidebarCollapsed(true);
                setShowSupportModal(true);
            };

            const handleSupportSubmit = async (e) => {
                e.preventDefault();
                setSupportSubmitting(true);
                setSupportError('');
                setSupportStatus('');
                try {
                    const res = await fetch(`${API_BASE}/api/support`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(supportForm)
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        throw new Error(data.error || 'Failed to submit support request');
                    }
                    setSupportStatus('Thanks! Your support request has been received.');
                    setSupportForm(prev => ({ ...prev, subject: '', message: '' }));
                } catch (err) {
                    setSupportError(err.message);
                } finally {
                    setSupportSubmitting(false);
                }
            };

            // Auth State
            const [isAuthenticated, setIsAuthenticated] = React.useState(false);
            const [currentUser, setCurrentUser] = React.useState(null);
            const [checkingAuth, setCheckingAuth] = React.useState(true);
            const [showAdmin, setShowAdmin] = React.useState(false);
            const [userList, setUserList] = React.useState([]);
            
            // Guest Mode State
            const [guestDocumentCount, setGuestDocumentCount] = React.useState(parseInt(localStorage.getItem('guestDocCount') || '0'));
            const GUEST_DOCUMENT_LIMIT = 1;
            const GUEST_COVERPAGE_LIMIT = 1;
            const [guestCoverpageCount, setGuestCoverpageCount] = React.useState(parseInt(localStorage.getItem('guestCPCount') || '0'));

            React.useEffect(() => {
                // Check auth status on load
                fetch(`${API_BASE}/api/auth/status`, { credentials: 'include' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.isAuthenticated) {
                            setIsAuthenticated(true);
                            setCurrentUser(data);
                            if (data.username) {
                                localStorage.setItem(REMEMBERED_USER_KEY, JSON.stringify({ username: data.username }));
                            }
                        }
                    })
                    .catch(err => console.error("Auth check failed", err))
                    .finally(() => setCheckingAuth(false));
            }, []);

            const handleLogin = (username) => {
                setIsAuthenticated(true);
                // Fetch full user details
                fetch(`${API_BASE}/api/auth/status`, { credentials: 'include' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.isAuthenticated) {
                            setCurrentUser(data);
                            if (data.username) {
                                localStorage.setItem(REMEMBERED_USER_KEY, JSON.stringify({ username: data.username }));
                            }
                        }
                    });
            };

            const handleLogout = async () => {
                try {
                    await fetch(`${API_BASE}/api/auth/logout`, { method: 'POST', credentials: 'include' });
                    setIsAuthenticated(false);
                    setCurrentUser(null);
                    setShowAdmin(false);
                    handleReset(); // Reset app state
                } catch (err) {
                    console.error("Logout failed", err);
                }
            };

            const fetchUsers = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/admin/users`, { credentials: 'include' });
                    if (res.ok) {
                        const data = await res.json();
                        setUserList(data);
                        setShowAdmin(true);
                    } else {
                        alert('Unauthorized access');
                    }
                } catch (err) {
                    console.error(err);
                }
            };

            const fetchInstitutionRequests = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/admin/institution-requests`, { credentials: 'include' });
                    if (res.ok) {
                        const data = await res.json();
                        setInstitutionRequests(data);
                    } else {
                        console.error('Failed to fetch institution requests');
                    }
                } catch (err) {
                    console.error(err);
                }
            };

            const handleDeleteUser = async (userId, username) => {
                const confirmText = prompt(`To delete user "${username}", please type: I want to delete the user`);
                if (confirmText !== 'I want to delete the user') {
                    if (confirmText !== null) {
                        alert('Incorrect confirmation text. User was NOT deleted.');
                    }
                    return;
                }
                try {
                    const res = await fetch(`${API_BASE}/api/admin/users/${userId}`, { method: 'DELETE', credentials: 'include' });
                    if (res.ok) {
                        fetchUsers(); // Refresh list
                        alert(`User "${username}" has been deleted successfully.`);
                    } else {
                        const data = await res.json();
                        alert(data.error || 'Failed to delete user');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Network error');
                }
            };

            const [selectedUserDocs, setSelectedUserDocs] = useState(null);
            const [loadingDocs, setLoadingDocs] = useState(false);
            const [adminSortBy, setAdminSortBy] = useState('created_at');
            const [adminSortOrder, setAdminSortOrder] = useState('desc');
            const [adminSearch, setAdminSearch] = useState('');
            const [expandedUserId, setExpandedUserId] = useState(null);
            const [adminTab, setAdminTab] = useState('users'); // users, documents, requests, support, or referrals
            const [institutionRequests, setInstitutionRequests] = useState([]);
            const [allDocuments, setAllDocuments] = useState([]);
            const [loadingDocuments, setLoadingDocuments] = useState(false);
            const [supportRequests, setSupportRequests] = useState([]);
            const [loadingSupportRequests, setLoadingSupportRequests] = useState(false);
            const [institutionFilter, setInstitutionFilter] = useState('');
            const [viewingUserDocs, setViewingUserDocs] = useState(null);

            const fetchAllDocuments = async () => {
                setLoadingDocuments(true);
                try {
                    const res = await fetch(`${API_BASE}/api/admin/documents`, { credentials: 'include' });
                    if (res.ok) {
                        const data = await res.json();
                        setAllDocuments(data);
                    } else {
                        console.error('Failed to fetch documents');
                    }
                } catch (err) {
                    console.error(err);
                } finally {
                    setLoadingDocuments(false);
                }
            };

            const fetchSupportRequests = async () => {
                setLoadingSupportRequests(true);
                try {
                    const res = await fetch(`${API_BASE}/api/admin/support`, { credentials: 'include' });
                    if (res.ok) {
                        const data = await res.json();
                        setSupportRequests(data);
                    } else {
                        console.error('Failed to fetch support requests');
                    }
                } catch (err) {
                    console.error(err);
                } finally {
                    setLoadingSupportRequests(false);
                }
            };

            const updateSupportRequestStatus = async (requestId, status) => {
                try {
                    const res = await fetch(`${API_BASE}/api/admin/support/${requestId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ status })
                    });
                    if (res.ok) {
                        fetchSupportRequests();
                    } else {
                        console.error('Failed to update support request');
                    }
                } catch (err) {
                    console.error(err);
                }
            };

            const handleDownloadDocument = (jobId, filename) => {
                window.open(`${API_BASE}/download/${jobId}`, '_blank');
            };

            const sortedUserList = React.useMemo(() => {
                let filtered = userList.filter(user => {
                    const matchesSearch = user.username?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                        user.email?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                        user.institution?.toLowerCase().includes(adminSearch.toLowerCase());
                    const matchesInstitution = !institutionFilter || user.institution === institutionFilter;
                    return matchesSearch && matchesInstitution;
                });
                
                return filtered.sort((a, b) => {
                    let aVal = a[adminSortBy];
                    let bVal = b[adminSortBy];
                    
                    if (adminSortBy === 'created_at' || adminSortBy === 'last_login' || adminSortBy === 'last_activity') {
                        aVal = aVal ? new Date(aVal).getTime() : 0;
                        bVal = bVal ? new Date(bVal).getTime() : 0;
                    }
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = (bVal || '').toLowerCase();
                    }
                    
                    if (adminSortOrder === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            }, [userList, adminSortBy, adminSortOrder, adminSearch, institutionFilter]);

            const handleSort = (field) => {
                if (adminSortBy === field) {
                    setAdminSortOrder(adminSortOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    setAdminSortBy(field);
                    setAdminSortOrder('desc');
                }
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            };

            const handleViewDocs = async (userId, username) => {
                setLoadingDocs(true);
                try {
                    const res = await fetch(`${API_BASE}/api/admin/users/${userId}/documents`, { credentials: 'include' });
                    if (res.ok) {
                        const docs = await res.json();
                        setSelectedUserDocs({ username, docs });
                    } else {
                        alert('Failed to fetch documents');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Network error');
                } finally {
                    setLoadingDocs(false);
                }
            };

            const handleDownloadDoc = (filename) => {
                window.open(`${API_BASE}/api/download/${filename}`, '_blank');
            };

            if (checkingAuth) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-midnight text-teal">
                        <div className="animate-spin"><Icons.Loader size={40} /></div>
                    </div>
                );
            }

            if (!isAuthenticated) {
                // Guest mode: Allow 1 document + 1 cover page before requiring signup
                // Once limit is reached, force signup (remove !result condition so it's blocking)
                const guestLimitReached = (guestDocumentCount >= GUEST_DOCUMENT_LIMIT || guestCoverpageCount >= GUEST_COVERPAGE_LIMIT);
                if (guestLimitReached) {
                    return <AuthPage onLogin={handleLogin} isSignup={true} guestLimitMessage="Sign up now to get free 300 pages every month!" />;
                }
                // Allow guest to use the app for free documents
            }

            // Stats data for display
            const statsData = result ? [
                { label: 'Headings', value: result.stats?.headings || 0, icon: Icons.Heading, color: 'text-teal' },
                { label: 'Paragraphs', value: result.stats?.paragraphs || 0, icon: Icons.FileText, color: 'text-ocean' },
                { label: 'References', value: result.stats?.references || 0, icon: Icons.Book, color: 'text-teal-light' },
                { label: 'Tables', value: result.stats?.tables || 0, icon: Icons.Table, color: 'text-amber' },
                { label: 'Lists', value: result.stats?.lists || 0, icon: Icons.List, color: 'text-coral' },
            ] : [];

            return (
                <div className="app-container text-white">
                    {/* Mobile Sidebar Overlay */}
                    <div 
                        className={`app-sidebar-overlay ${appSidebarOpen ? 'open' : ''}`}
                        onClick={() => setAppSidebarOpen(false)}
                    />

                    {/* Global Sidebar */}
                    <aside className={`app-sidebar ${appSidebarOpen ? 'open' : ''} ${sidebarCollapsed ? 'collapsed' : ''}`}>
                        {/* Sidebar Header with collapse toggle */}
                        <div className="app-sidebar-header">
                            <div 
                                className="app-sidebar-logo cursor-pointer" 
                                onClick={() => sidebarCollapsed && setSidebarCollapsed(false)}
                                title={sidebarCollapsed ? 'Expand sidebar' : ''}
                            >
                                <img src="logo/logo.png" alt="AfroDocs" />
                            </div>
                            <div>
                                    <div className="app-sidebar-title">AfroDocs</div>
                                    <div className="app-sidebar-subtitle">Document Formatter</div>
                            </div>
                            <div className="app-sidebar-actions">
                                <button 
                                    onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                                    className="p-1.5 hover:bg-white/10 rounded-md transition-colors hidden md:flex"
                                    title={sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
                                >
                                    <svg 
                                        xmlns="http://www.w3.org/2000/svg" 
                                        width="18" 
                                        height="18" 
                                        viewBox="0 0 24 24" 
                                        fill="none" 
                                        stroke="currentColor" 
                                        strokeWidth="2" 
                                        strokeLinecap="round" 
                                        strokeLinejoin="round"
                                        className={`text-mist transition-transform duration-200 ${sidebarCollapsed ? 'rotate-180' : ''}`}
                                    >
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="9" y1="3" x2="9" y2="21"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        {/* Navigation */}
                        <nav className="app-nav">
                            {/* Main Tools */}
                            <div className="app-nav-section">
                                <div className="app-nav-section-title">Tools</div>
                                
                                <button
                                    onClick={() => { setViewMode('formatter'); setAppSidebarOpen(false); setShowProfile(false); }}
                                    className={`app-nav-item ${viewMode === 'formatter' ? 'active' : ''}`}
                                    title="Document Formatter"
                                >
                                    <span className="app-nav-item-icon"><Icons.FileText size={20} /></span>
                                    <span>Document Formatter</span>
                                </button>
                                
                                <button
                                    onClick={() => { setViewMode('ai'); setAppSidebarOpen(false); setShowProfile(false); setShowAiAssistant(true); }}
                                    className={`app-nav-item ${viewMode === 'ai' ? 'active' : ''}`}
                                    title="AI Mode"
                                >
                                    <span className="app-nav-item-icon"><Icons.ChatExpand size={20} /></span>
                                    <span>AI Mode</span>
                                </button>
                                
                                <button
                                    onClick={() => { setViewMode('coverpage'); setAppSidebarOpen(false); setShowProfile(false); }}
                                    className={`app-nav-item ${viewMode === 'coverpage' ? 'active' : ''}`}
                                    title="Cover Page Generator"
                                >
                                    <span className="app-nav-item-icon"><Icons.Layout size={20} /></span>
                                    <span>Cover Page Generator</span>
                                </button>
                            </div>

                            {/* User Documents Section */}
                            {userDocuments.length > 0 && (
                                <div className="app-nav-section">
                                    <div className="app-nav-section-title">Your Documents</div>
                                    {(showAllDocuments ? userDocuments : userDocuments.slice(0, 4)).map((doc, index) => (
                                        <div key={doc.id || index} className="app-nav-item group flex items-center justify-between gap-2">
                                            <button
                                                onClick={() => { 
                                                    setResult(doc.result);
                                                    setPdfPreviewUrl(doc.pdfUrl);
                                                    setViewMode('formatter');
                                                    setAppSidebarOpen(false);
                                                    setShowProfile(false);
                                                }}
                                                className="flex items-center gap-2 flex-1 text-left"
                                                title={doc.name}
                                            >
                                                <span className="app-nav-item-icon"><Icons.File size={18} /></span>
                                                <span className="truncate text-xs">{doc.name}</span>
                                            </button>
                                            <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button
                                                    onClick={(event) => { event.stopPropagation(); handleRenameDocument(doc); }}
                                                    className="p-1 text-mist hover:text-white hover:bg-white/10 rounded"
                                                    title="Rename document"
                                                >
                                                    <Icons.Edit size={12} />
                                                </button>
                                                <button
                                                    onClick={(event) => { event.stopPropagation(); handleDeleteDocument(doc); }}
                                                    className="p-1 text-mist hover:text-coral hover:bg-white/10 rounded"
                                                    title="Delete document"
                                                >
                                                    <Icons.Trash size={12} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                    {userDocuments.length > 4 && (
                                        <button
                                            onClick={() => setShowAllDocuments(!showAllDocuments)}
                                            className="app-nav-item text-teal hover:text-teal-light"
                                            title={showAllDocuments ? "Show less" : "See more documents"}
                                        >
                                            <span className="app-nav-item-icon">
                                                {showAllDocuments ? <Icons.ChevronUp size={18} /> : <Icons.ChevronDown size={18} />}
                                            </span>
                                            <span className="text-xs">{showAllDocuments ? 'Show Less' : `See More (${userDocuments.length - 4})`}</span>
                                        </button>
                                    )}
                                </div>
                            )}

                            {/* Admin Section */}
                            {currentUser?.username === 'admin' && (
                                <div className="app-nav-section">
                                    <div className="app-nav-section-title">Admin</div>
                                    <button onClick={() => { fetchUsers(); fetchInstitutionRequests(); setAdminTab('users'); setShowProfile(false); }} className="app-nav-item" title="Manage Users">
                                        <span className="app-nav-item-icon"><Icons.Users size={20} /></span>
                                        <span>Manage Users</span>
                                    </button>
                                </div>
                            )}

                            {/* Community Link */}
                            <div className="app-nav-section mt-auto">
                                <a 
                                    href="https://chat.whatsapp.com/CrSrujvvZj41FNvIWbkJoG?mode=gi_t" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="app-nav-item hover:text-teal"
                                    title="Join our community"
                                >
                                    <span className="app-nav-item-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="9" cy="7" r="4"></circle>
                                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                        </svg>
                                    </span>
                                    <span>Join our community</span>
                                </a>
                                <button
                                    onClick={openSupportModal}
                                    className="app-nav-item hover:text-teal"
                                    title="Contact support"
                                >
                                    <span className="app-nav-item-icon"><Icons.MessageSquare size={18} /></span>
                                    <span>Contact support</span>
                                </button>
                            </div>
                        </nav>

                        {/* Sidebar Footer - User */}
                        <div className="app-sidebar-footer">
                            <button 
                                onClick={() => setShowProfile(!showProfile)}
                                className="app-user-button"
                            >
                                <div className="app-user-avatar">
                                    {currentUser?.username?.charAt(0).toUpperCase() || 'U'}
                                </div>
                                <div className="app-user-info text-left flex-1">
                                    <div className="app-user-name text-left">{currentUser?.username || 'User'}</div>
                                    <div className="app-user-plan text-left flex items-center gap-2">
                                        {currentUser?.pages_balance > 0 ? (
                                            <span className="text-teal">Pro Account</span>
                                        ) : (
                                            <>
                                                <span>Free</span>
                                                <span className="px-1.5 py-0.5 bg-gradient-to-r from-[#1E5A8E] to-teal text-white text-[9px] font-bold rounded">UPGRADE</span>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <Icons.ChevronDown />
                            </button>
                            
                            {/* Profile Dropdown - Minimal */}
                            {showProfile && !sidebarCollapsed && (
                                <div className="mt-2 bg-[#0a1929] border border-teal/20 rounded-lg overflow-hidden shadow-lg">
                                    <div className="p-2 space-y-1.5">
                                        {currentUser?.pages_balance > 0 ? (
                                            // Pro account - show paid balance usage
                                            <>
                                                <div className="flex items-center justify-between text-[10px]">
                                                    <span className="text-mist">Paid Balance</span>
                                                    <span className="text-teal font-bold">{currentUser?.pages_balance || 0} pages</span>
                                                </div>
                                            </>
                                        ) : (
                                            // Free account - show free tier usage
                                            <>
                                                <div className="flex items-center justify-between text-[10px]">
                                                    <span className="text-mist">Free Usage</span>
                                                    <span className="font-medium">{currentUser?.pages_this_month || 0}/300</span>
                                                </div>
                                                <div className="w-full bg-white/10 rounded-full h-1">
                                                    <div className="bg-gradient-to-r from-[#1E5A8E] to-teal h-1 rounded-full" style={{width: `${Math.min((currentUser?.pages_this_month || 0) / 300 * 100, 100)}%`}}></div>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                    <div className="p-2 pt-1.5 border-t border-teal/10 space-y-2">
                                        <button
                                            onClick={() => { setShowPricingModal(true); setShowProfile(false); setSidebarCollapsed(true); }}
                                            className="w-full py-1.5 bg-gradient-to-r from-[#1E5A8E] to-teal text-white rounded text-[10px] font-bold hover:opacity-90 transition-all"
                                        >
                                            Upgrade
                                        </button>
                                        {/* Referral Link */}
                                        {currentUser?.referral_code && (
                                            <div className="bg-white/5 rounded p-1.5 flex items-center justify-between" style={{minWidth: '160px'}}>
                                                <div className="text-sm text-mist">Promo Code</div>
                                                <div className="flex items-center gap-2">
                                                    <button
                                                        onClick={() => {
                                                            const link = `${window.location.origin}?ref=${currentUser.referral_code}`;
                                                            navigator.clipboard.writeText(link);
                                                            try { alert('Promo link copied to clipboard'); } catch(e){}
                                                        }}
                                                        className="px-2 py-1 bg-transparent text-teal rounded text-xs font-medium hover:bg-white/5 transition-all"
                                                        title="Copy promo link"
                                                    >
                                                        <Icons.Copy size={14} />
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            const link = `${window.location.origin}?ref=${currentUser.referral_code}`;
                                                            if (navigator.share) {
                                                                navigator.share({ title: 'AfroDocs Promo', text: 'Join AfroDocs', url: link }).catch(() => navigator.clipboard.writeText(link));
                                                            } else {
                                                                navigator.clipboard.writeText(link);
                                                                try { alert('Promo link copied to clipboard'); } catch(e){}
                                                            }
                                                        }}
                                                        className="px-2 py-1 bg-teal/10 text-teal rounded text-xs font-medium hover:bg-teal/20 transition-all"
                                                        title="Share promo link"
                                                    >
                                                        Share
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                        <button 
                                            onClick={handleLogout}
                                            className="w-full px-2 py-1.5 text-[10px] text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded transition-colors text-center"
                                        >
                                            Logout
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="app-main">
                        {/* Header */}
                        <header className="app-main-header">
                            <div className="flex items-center justify-between w-full">
                                <div className="flex items-center gap-3">
                                    <button 
                                        onClick={() => setAppSidebarOpen(!appSidebarOpen)}
                                        className="app-mobile-toggle"
                                        aria-label="Toggle sidebar"
                                    >
                                        <Icons.Menu size={20} />
                                    </button>
                                    <h1 className="app-main-title">
                                        {!viewMode && 'Welcome to AfroDocs'}
                                        {viewMode === 'formatter' && 'Document Formatter'}
                                        {viewMode === 'ai' && 'AI Mode'}
                                        {viewMode === 'coverpage' && 'Cover Page Generator'}
                                    </h1>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="app-version-tag">Afrodocs version 2.0.</div>
                                    {(canInstall || isIosDevice || isInstalled || updateAvailable) && (
                                        <button
                                            onClick={handleInstallClick}
                                            className="app-install-button"
                                            disabled={isInstalled && !updateAvailable}
                                            title={updateAvailable ? 'Update AfroDocs' : (isInstalled ? 'AfroDocs is installed' : 'Install AfroDocs')}
                                        >
                                            {updateAvailable ? <Icons.RefreshCw size={14} /> : <Icons.Download size={14} />}
                                            <span>
                                                {updateAvailable ? 'Update app' : (isInstalled ? 'Installed' : 'Install')}
                                            </span>
                                        </button>
                                    )}
                                </div>
                            </div>
                        </header>

                        {/* Content Area */}
                        <div className="app-main-content">
                            {/* Error Display */}
                            {error && (
                                <div className={errorIsPositive ? "mb-4 bg-green-500/20 border border-green-500/50 text-green-200 p-4 rounded-xl" : "mb-4 bg-red-500/20 border border-red-500/50 text-red-200 p-4 rounded-xl"}>
                                    <div className="flex items-center gap-3">
                                        {errorIsPositive ? <Icons.CheckCircle size={20} /> : <Icons.X size={20} />}
                                        <div>
                                            <p className="font-medium">{errorIsPositive ? 'Notice' : 'Error'}</p>
                                            <p className="text-sm opacity-90">{error}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {!viewMode && (
                                <div className="max-w-3xl mx-auto">
                                    <div className="content-card">
                                        <div className="content-card-body text-center py-12">
                                            <div className="flex justify-center mb-4">
                                                <span className="text-teal"><Icons.Zap size={32} /></span>
                                            </div>
                                            <h2 className="text-xl font-semibold text-white mb-2">Choose where to start</h2>
                                            <p className="text-sm text-mist">
                                                Your sidebar is open so you can explore the tools and pick the best starting point.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Formatter View */}
                            {viewMode === 'formatter' && (
                                <div className="max-w-4xl mx-auto">
                                    {!result && !processing ? (
                                        <>
                                            {/* Upload Section */}
                                            <div className="content-card mb-6">
                                                <div className="content-card-header">
                                                    <div className="content-card-title">
                                                        Upload Document
                                                    </div>
                                                </div>
                                                <div className="content-card-body">
                                                    <input
                                                        ref={fileInputRef}
                                                        type="file"
                                                        accept=".txt,.docx,.md,.doc"
                                                        onChange={handleFileInputChange}
                                                        className="hidden"
                                                    />
                                                    <div
                                                        onClick={() => fileInputRef.current?.click()}
                                                        onDragOver={handleDragOver}
                                                        onDragLeave={handleDragLeave}
                                                        onDrop={handleDrop}
                                                        className={`file-drop-zone ${dragOver ? 'drag-over' : ''}`}
                                                    >
                                                        <div className="file-drop-zone-icon">
                                                            <Icons.Upload />
                                                        </div>
                                                        <p className="text-white font-medium mb-1">
                                                            {file ? file.name : 'Click to upload or drop file here'}
                                                        </p>
                                                        <p className="text-mist text-sm">
                                                            Supports .txt, .docx, .md files â€¢ Max 50MB
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Paste Text Section */}
                                            <div className="content-card mb-6">
                                                <div className="content-card-header">
                                                    <div className="content-card-title">
                                                        <Icons.FileText size={18} /> Or Paste Text
                                                    </div>
                                                </div>
                                                <div className="content-card-body">
                                                    <textarea
                                                        value={pastedText}
                                                        onChange={(e) => setPastedText(e.target.value)}
                                                        placeholder="Paste your document content here..."
                                                        className="unified-textarea"
                                                    />
                                                    {pastedText && (
                                                        <div className="quick-actions">
                                                            <button
                                                                onClick={handlePasteSubmit}
                                                                className="quick-action-btn primary"
                                                            >
                                                                <Icons.Zap /> Format Document
                                                            </button>
                                                            {isPastedTextWithinAiLimit && (
                                                                <button
                                                                    onClick={handleRestructurePastedText}
                                                                    className="quick-action-btn"
                                                                    disabled={isRestructuringPaste}
                                                                >
                                                                    {isRestructuringPaste ? <Icons.Loader size={16} /> : <Icons.Sparkles size={16} />}
                                                                    {isRestructuringPaste ? 'Restructuring...' : 'Restructure'}
                                                                </button>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </>
                                    ) : processing ? (
                                        /* Processing State */
                                        <div className="content-card">
                                            <div className="content-card-body py-16">
                                                <div className="relative w-full h-48 flex items-center justify-center">
                                                    <div className="absolute inset-0 tech-grid opacity-30"></div>
                                                    <div className="lightning-flash-container">
                                                        <div className="lightning-bolt">
                                                            <Icons.Zap size={64} />
                                                        </div>
                                                    </div>
                                                </div>
                                                <p className="text-teal font-mono text-lg font-bold tracking-widest tabular-nums mt-4 text-center">
                                                    {(() => {
                                                        const mins = Math.floor(elapsedTime / 60000).toString().padStart(2, '0');
                                                        const secs = Math.floor((elapsedTime % 60000) / 1000).toString().padStart(2, '0');
                                                        const ms = Math.floor((elapsedTime % 1000) / 10).toString().padStart(2, '0');
                                                        return `${mins}:${secs}:${ms}`;
                                                    })()}
                                                </p>
                                                <p className="text-mist text-sm mt-2 text-center">{status || 'Processing...'}</p>
                                            </div>
                                        </div>
                                    ) : result && (
                                        /* Result State */
                                        <div className="space-y-6">
                                            {/* Success Banner */}
                                            {showSuccessMessage && (
                                                <div className="bg-teal/20 border border-teal/50 rounded-xl p-3 text-center">
                                                    <p className="font-medium text-white">Document formatted successfully.</p>
                                                </div>
                                            )}

                                            {/* Action Buttons - Minimal on Mobile */}
                                            <div className="grid grid-cols-2 md:flex md:flex-wrap gap-2 md:gap-3">
                                                <button
                                                    onClick={() => handleDownload('docx')}
                                                    className="flex items-center justify-center gap-1.5 px-3 py-2 md:px-4 md:py-2.5 bg-gradient-to-r from-teal to-cyan-600 text-white rounded-lg text-xs md:text-sm font-medium hover:opacity-90 transition-all"
                                                >
                                                    <Icons.Download /> <span className="hidden sm:inline">Download</span> DOCX
                                                </button>
                                                <button
                                                    onClick={() => handleDownload('pdf')}
                                                    className="flex items-center justify-center gap-1.5 px-3 py-2 md:px-4 md:py-2.5 bg-gradient-to-r from-teal to-cyan-600 text-white rounded-lg text-xs md:text-sm font-medium hover:opacity-90 transition-all"
                                                >
                                                    <Icons.Download /> <span className="hidden sm:inline">Download</span> PDF
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        const currentJobId = result.job_id;
                                                        setMergeJobId(currentJobId);
                                                        setCoverpageOpening(true);
                                                        setViewMode('coverpage');
                                                    }}
                                                    className="flex items-center justify-center gap-2 px-5 py-1.5 bg-white/10 border border-white/20 text-white rounded-lg text-sm md:text-base font-semibold hover:bg-white/20 transition-all"
                                                >
                                                    <Icons.Layout /> Add Cover Page
                                                </button>
                                                <button
                                                    onClick={handleReset}
                                                    className="flex items-center justify-center gap-2 px-5 py-1.5 bg-white/10 border border-white/20 text-white rounded-lg text-sm md:text-base font-semibold hover:bg-white/20 transition-all"
                                                    title="Refresh"
                                                >
                                                    Refresh
                                                </button>
                                            </div>

                                            {/* Preview */}
                                            <div className="content-card">
                                                <div className="content-card-header">
                                                    <div className="content-card-title">
                                                        Document Preview
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {pdfPreviewError && (
                                                            <button
                                                                onClick={() => {
                                                                    setPdfPreviewError(false);
                                                                    setPdfPreviewLoading(true);
                                                                    setPdfPreviewKey(prev => prev + 1);
                                                                }}
                                                                className="quick-action-btn text-amber"
                                                            >
                                                                <Icons.RefreshCw size={16} /> Retry
                                                            </button>
                                                        )}
                                                        <button
                                                            onClick={() => setShowPdfModal(true)}
                                                            className="quick-action-btn"
                                                        >
                                                            <Icons.Maximize /> Full Screen
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="h-[500px] md:h-[700px] bg-slate-900 relative">
                                                    {pdfPreviewUrl ? (
                                                        <>
                                                            {pdfPreviewLoading && !pdfPreviewError && (
                                                                <div className="absolute inset-0 flex items-center justify-center text-mist flex-col gap-4 bg-slate-900 z-10">
                                                                    <div className="lightning-loading">
                                                                        <Icons.Zap />
                                                                    </div>
                                                                    <p>Loading preview...</p>
                                                                </div>
                                                            )}
                                                            {pdfPreviewError ? (
                                                                <div className="flex items-center justify-center h-full text-mist flex-col gap-4">
                                                                    <Icons.AlertCircle size={48} className="text-amber" />
                                                                    <p className="text-center">Preview failed to load</p>
                                                                    <button
                                                                        onClick={() => {
                                                                            setPdfPreviewError(false);
                                                                            setPdfPreviewLoading(true);
                                                                            setPdfPreviewKey(prev => prev + 1);
                                                                        }}
                                                                        className="px-4 py-2 bg-teal/20 hover:bg-teal/30 text-teal rounded-lg transition-colors flex items-center gap-2"
                                                                    >
                                                                        <Icons.RefreshCw size={16} /> Retry Loading
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <>
                                                                    {/* Mobile-friendly PDF display with Open button */}
                                                                    {/* Mobile PDF.js viewer */}
                                                                    <div className="md:hidden h-full">
                                                                        <MobilePdfViewer pdfUrl={pdfPreviewUrl} maxHeight={450} />
                                                                    </div>
                                                                    {/* Desktop iframe preview */}
                                                                    <iframe 
                                                                        key={pdfPreviewKey}
                                                                        src={`${pdfPreviewUrl}#toolbar=0&navpanes=0&scrollbar=0&view=FitH`}
                                                                        className="w-full h-full border-0 hidden md:block"
                                                                        title="PDF Preview"
                                                                        onLoad={() => setPdfPreviewLoading(false)}
                                                                        onError={() => {
                                                                            setPdfPreviewLoading(false);
                                                                            setPdfPreviewError(true);
                                                                        }}
                                                                    />
                                                                </>
                                                            )}
                                                        </>
                                                    ) : (
                                                        <div className="flex items-center justify-center h-full text-mist flex-col gap-4">
                                                            <div className="lightning-loading">
                                                                <Icons.Zap />
                                                            </div>
                                                            <p>Loading preview...</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* AI View - Full Page */}
                            {viewMode === 'ai' && (
                                <div className="h-full -m-4 md:-m-6">
                                    <AiAssistant 
                                        isExpanded={showAiAssistant}
                                        onToggle={() => setShowAiAssistant(false)}
                                        onFormatText={handleAiFormatText}
                                        sidebarOpen={aiSidebarOpen}
                                        setSidebarOpen={setAiSidebarOpen}
                                    />
                                </div>
                            )}

                            {/* Cover Page View */}
                            {viewMode === 'coverpage' && (
                                <CoverPageGenerator 
                                    mergeJobId={mergeJobId} 
                                    setPdfPreviewUrl={setPdfPreviewUrl} 
                                    pdfPreviewUrl={pdfPreviewUrl}
                                    setPdfViewParam={setPdfViewParam}
                                    setShowPdfModal={setShowPdfModal}
                                    opening={coverpageOpening}
                                    setOpening={setCoverpageOpening}
                                />
                            )}
                        </div>
                    </main>

                    {/* Modals */}
                    <PdfPreviewModal 
                        url={showPdfModal ? pdfPreviewUrl : null} 
                        onClose={() => setShowPdfModal(false)} 
                        viewParam={pdfViewParam}
                    />

                    <FormattingOptionsModal 
                        isOpen={showFormattingModal} 
                        onClose={() => {
                            setShowFormattingModal(false);
                            setPendingFile(null);
                            setPastedText('');
                        }}
                        onApply={(options) => {
                            if (pendingFile) {
                                processFileWithOptions(pendingFile, options);
                                setPendingFile(null);
                            }
                        }}
                        options={formattingOptions}
                        setOptions={setFormattingOptions}
                    />

                    <PricingModal 
                        isOpen={showPricingModal} 
                        onClose={() => { setShowPricingModal(false); setPricingLimitReached(false); }} 
                        onSelectPlan={handleUpgrade}
                        limitReached={pricingLimitReached}
                    />

                    {showSupportModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className="bg-[#0a1929] border border-teal/20 rounded-2xl w-full max-w-lg shadow-2xl">
                                <div className="p-4 border-b border-teal/10 flex items-center justify-between">
                                    <div>
                                        <h3 className="text-lg font-bold text-white">Contact Support</h3>
                                        <p className="text-xs text-mist">We usually respond within 24 hours.</p>
                                    </div>
                                    <button
                                        onClick={() => setShowSupportModal(false)}
                                        className="text-mist hover:text-white transition-colors p-1"
                                    >
                                        <Icons.X size={20} />
                                    </button>
                                </div>
                                <form onSubmit={handleSupportSubmit} className="p-4 space-y-3">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs text-mist mb-1">Name</label>
                                            <input
                                                type="text"
                                                value={supportForm.name}
                                                onChange={(e) => setSupportForm(prev => ({ ...prev, name: e.target.value }))}
                                                className="w-full px-3 py-2 rounded-lg glass-input text-sm"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-mist mb-1">Email</label>
                                            <input
                                                type="email"
                                                value={supportForm.email}
                                                onChange={(e) => setSupportForm(prev => ({ ...prev, email: e.target.value }))}
                                                className="w-full px-3 py-2 rounded-lg glass-input text-sm"
                                                required
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-mist mb-1">Subject</label>
                                        <input
                                            type="text"
                                            value={supportForm.subject}
                                            onChange={(e) => setSupportForm(prev => ({ ...prev, subject: e.target.value }))}
                                            className="w-full px-3 py-2 rounded-lg glass-input text-sm"
                                            placeholder="How can we help?"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs text-mist mb-1">Message</label>
                                        <textarea
                                            rows="4"
                                            value={supportForm.message}
                                            onChange={(e) => setSupportForm(prev => ({ ...prev, message: e.target.value }))}
                                            className="w-full px-3 py-2 rounded-lg glass-input text-sm"
                                            placeholder="Share details about the issue or question..."
                                            required
                                        />
                                    </div>
                                    {supportError && (
                                        <div className="text-xs text-red-400">{supportError}</div>
                                    )}
                                    {supportStatus && (
                                        <div className="text-xs text-teal">{supportStatus}</div>
                                    )}
                                    <div className="flex items-center justify-end gap-2 pt-2">
                                        <button
                                            type="button"
                                            onClick={() => setShowSupportModal(false)}
                                            className="px-4 py-2 text-xs text-mist hover:text-white"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            disabled={supportSubmitting}
                                            className="px-4 py-2 bg-gradient-to-r from-[#1E5A8E] to-teal text-white rounded-lg text-xs font-bold hover:opacity-90 transition-all disabled:opacity-60"
                                        >
                                            {supportSubmitting ? 'Sending...' : 'Send message'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {renameDoc && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className="bg-[#0a1929] border border-teal/20 rounded-2xl w-full max-w-md shadow-2xl">
                                <div className="p-4 border-b border-teal/10 flex items-center justify-between">
                                    <h3 className="text-lg font-bold text-white">Rename Document</h3>
                                    <button
                                        onClick={() => setRenameDoc(null)}
                                        className="text-mist hover:text-white transition-colors p-1"
                                    >
                                        <Icons.X size={20} />
                                    </button>
                                </div>
                                <div className="p-4 space-y-3">
                                    <label className="block text-xs text-mist">New name</label>
                                    <input
                                        type="text"
                                        value={renameValue}
                                        onChange={(e) => setRenameValue(e.target.value)}
                                        className="w-full px-3 py-2 rounded-lg glass-input text-sm"
                                        placeholder="Enter a new document name"
                                    />
                                    {renameError && (
                                        <div className="text-xs text-red-400">{renameError}</div>
                                    )}
                                    <div className="flex items-center justify-end gap-2 pt-2">
                                        <button
                                            type="button"
                                            onClick={() => setRenameDoc(null)}
                                            className="px-4 py-2 text-xs text-mist hover:text-white"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleApplyRename}
                                            disabled={renameSubmitting}
                                            className="px-4 py-2 bg-gradient-to-r from-[#1E5A8E] to-teal text-white rounded-lg text-xs font-bold hover:opacity-90 transition-all disabled:opacity-60"
                                        >
                                            {renameSubmitting ? 'Saving...' : 'Save'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Payment Success Modal */}
                    {showPaymentSuccessModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                            <div className="bg-ocean-dark border border-teal/30 rounded-2xl shadow-2xl max-w-md w-full p-8 text-center">
                                <div className="w-20 h-20 bg-teal/20 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Icons.CheckCircle size={48} className="text-teal" />
                                </div>
                                <h2 className="text-2xl font-bold text-white mb-3">Payment Successful!</h2>
                                <p className="text-mist mb-6">
                                    Your account has been credited successfully. Your new balance is now available.
                                </p>
                                <div className="bg-teal/10 border border-teal/20 rounded-xl p-4 mb-6">
                                    <div className="text-sm text-mist mb-1">Updated Balance</div>
                                    <div className="text-3xl font-bold text-teal">{currentUser?.pages_balance || 0} pages</div>
                                </div>
                                <button
                                    onClick={() => setShowPaymentSuccessModal(false)}
                                    className="w-full bg-gradient-to-r from-teal to-cyan-600 text-white font-medium py-3 px-6 rounded-xl hover:opacity-90 transition-all"
                                >
                                    Continue
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Admin Panel - Enhanced */}
                    {showAdmin && (
                        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-start justify-center z-50 p-2 md:p-4 overflow-y-auto">
                            <div className="bg-[#0a1929] border border-teal/20 rounded-xl w-full max-w-7xl my-4 shadow-2xl">
                                {/* Header */}
                                <div className="p-3 md:p-4 border-b border-teal/20 flex flex-col md:flex-row justify-between items-start md:items-center gap-3 sticky top-0 bg-[#0a1929] z-10 rounded-t-xl">
                                    <div>
                                        <h2 className="text-lg md:text-xl font-bold text-white flex items-center gap-2">
                                            <Icons.Settings size={20} />
                                            Admin Dashboard
                                        </h2>
                                        <p className="text-xs text-mist">
                                            {adminTab === 'users' && `${sortedUserList.length} users`}
                                            {adminTab === 'documents' && `${allDocuments.length} documents`}
                                            {adminTab === 'requests' && `${institutionRequests.length} requests`}
                                            {adminTab === 'support' && `${supportRequests.length} support requests`}
                                        </p>
                                    </div>
                                    <div className="flex items-center gap-2 w-full md:w-auto">
                                        <input
                                            type="text"
                                            placeholder="Search..."
                                            value={adminSearch}
                                            onChange={(e) => setAdminSearch(e.target.value)}
                                            className="flex-1 md:w-64 px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm placeholder-mist focus:border-teal/50 focus:outline-none"
                                        />
                                        <button onClick={() => setShowAdmin(false)} className="p-2 text-mist hover:text-white hover:bg-white/10 rounded-lg transition-colors">
                                            <Icons.X size={20} />
                                        </button>
                                    </div>
                                </div>

                                {/* Tabs */}
                                <div className="flex border-b border-teal/20">
                                    <button
                                        onClick={() => { setAdminTab('users'); fetchUsers(); }}
                                        className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                                            adminTab === 'users'
                                                ? 'text-teal border-b-2 border-teal bg-white/5'
                                                : 'text-mist hover:text-white'
                                        }`}
                                    >
                                        <Icons.Users size={16} /> Users
                                    </button>
                                    <button
                                        onClick={() => { setAdminTab('documents'); fetchAllDocuments(); }}
                                        className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                                            adminTab === 'documents'
                                                ? 'text-teal border-b-2 border-teal bg-white/5'
                                                : 'text-mist hover:text-white'
                                        }`}
                                    >
                                        <Icons.FileText size={16} /> Documents
                                    </button>
                                    <button
                                        onClick={() => { setAdminTab('requests'); fetchInstitutionRequests(); }}
                                        className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                                            adminTab === 'requests'
                                                ? 'text-teal border-b-2 border-teal bg-white/5'
                                                : 'text-mist hover:text-white'
                                        }`}
                                    >
                                        <Icons.Book size={16} /> Requests
                                    </button>
                                    <button
                                        onClick={() => { setAdminTab('support'); fetchSupportRequests(); }}
                                        className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                                            adminTab === 'support'
                                                ? 'text-teal border-b-2 border-teal bg-white/5'
                                                : 'text-mist hover:text-white'
                                        }`}
                                    >
                                        <Icons.MessageSquare size={16} /> Support
                                    </button>
                                    <button
                                        onClick={() => setAdminTab('referrals')}
                                        className={`flex-1 px-4 py-3 text-sm font-medium transition-colors flex items-center justify-center gap-2 ${
                                            adminTab === 'referrals'
                                                ? 'text-teal border-b-2 border-teal bg-white/5'
                                                : 'text-mist hover:text-white'
                                        }`}
                                    >
                                        <Icons.Users size={16} /> Referrals
                                    </button>
                                </div>

                                {/* KPIs Section */}
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 p-3 bg-white/5">
                                    <div className="bg-[#0a1929] rounded-lg p-3 border border-teal/10">
                                        <div className="text-xs text-mist mb-1">Total Users</div>
                                        <div className="text-xl font-bold text-teal">{userList.length}</div>
                                    </div>
                                    <div className="bg-[#0a1929] rounded-lg p-3 border border-teal/10">
                                        <div className="text-xs text-mist mb-1">Institutions</div>
                                        <div className="text-xl font-bold text-white">{[...new Set(userList.map(u => u.institution).filter(Boolean))].length}</div>
                                    </div>
                                    <div className="bg-[#0a1929] rounded-lg p-3 border border-teal/10">
                                        <div className="text-xs text-mist mb-1">Total Documents</div>
                                        <div className="text-xl font-bold text-white">{userList.reduce((sum, u) => sum + (u.documents_generated || 0), 0)}</div>
                                    </div>
                                    <div className="bg-[#0a1929] rounded-lg p-3 border border-teal/10">
                                        <div className="text-xs text-mist mb-1">Referrals</div>
                                        <div className="text-xl font-bold text-purple-400">{userList.filter(u => u.referred_by).length}</div>
                                    </div>
                                </div>

                                {/* Users Tab Content - Table Format */}
                                {adminTab === 'users' && (
                                <div className="p-2 md:p-4">
                                    {/* Sort and Filter Controls */}
                                    <div className="mb-3 flex flex-wrap gap-2 text-xs">
                                        <span className="text-mist self-center">Sort by:</span>
                                        {[
                                            {key: 'created_at', label: 'Joined'},
                                            {key: 'username', label: 'Name'},
                                            {key: 'documents_generated', label: 'Docs'},
                                            {key: 'ai_requests_count', label: 'AI'},
                                            {key: 'pages_this_month', label: 'Pages'},
                                            {key: 'institution', label: 'Institution'}
                                        ].map(({key, label}) => (
                                            <button
                                                key={key}
                                                onClick={() => handleSort(key)}
                                                className={`px-2 py-1 rounded ${adminSortBy === key ? 'bg-teal/20 text-teal border border-teal/30' : 'bg-white/5 text-mist hover:bg-white/10'} transition-colors`}
                                            >
                                                {label} {adminSortBy === key && (adminSortOrder === 'asc' ? 'â†‘' : 'â†“')}
                                            </button>
                                        ))}
                                    </div>
                                    
                                    {/* Institution Filter */}
                                    <div className="mb-3">
                                        <select 
                                            value={institutionFilter}
                                            onChange={(e) => setInstitutionFilter(e.target.value)}
                                            className="px-3 py-1.5 bg-white/5 border border-white/10 rounded text-sm text-white"
                                        >
                                            <option value="">All Institutions</option>
                                            {[...new Set(userList.map(u => u.institution).filter(Boolean))].sort().map(inst => (
                                                <option key={inst} value={inst}>{inst}</option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* Users Table */}
                                    <div className="overflow-x-auto max-h-[60vh] overflow-y-auto">
                                        <table className="w-full text-sm">
                                            <thead className="bg-white/5 sticky top-0">
                                                <tr className="text-left text-mist text-xs">
                                                    <th className="px-3 py-2 font-medium">User</th>
                                                    <th className="px-3 py-2 font-medium hidden md:table-cell">Email</th>
                                                    <th className="px-3 py-2 font-medium hidden lg:table-cell">Institution</th>
                                                    <th className="px-3 py-2 font-medium text-center">Docs</th>
                                                    <th className="px-3 py-2 font-medium text-center">AI</th>
                                                    <th className="px-3 py-2 font-medium text-center">Pages</th>
                                                    <th className="px-3 py-2 font-medium text-center">Balance</th>
                                                    <th className="px-3 py-2 font-medium hidden md:table-cell">Joined</th>
                                                    <th className="px-3 py-2 font-medium text-center">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-white/5">
                                                {sortedUserList.map(user => (
                                                    <tr key={user.id} className="hover:bg-white/5 transition-colors">
                                                        <td className="px-3 py-2">
                                                            <div className="flex items-center gap-2">
                                                                <div className="w-7 h-7 bg-gradient-to-r from-[#1E5A8E] to-teal rounded-full flex items-center justify-center text-white text-xs font-bold">
                                                                    {user.username?.charAt(0).toUpperCase()}
                                                                </div>
                                                                <div>
                                                                    <div className="text-white font-medium text-xs flex items-center gap-1">
                                                                        {user.username}
                                                                        {user.is_admin && <span className="text-[8px] bg-amber/20 text-amber px-1 rounded">ADM</span>}
                                                                    </div>
                                                                    <div className="text-mist text-[10px] md:hidden">{user.email || '-'}</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td className="px-3 py-2 text-mist text-xs hidden md:table-cell">{user.email || '-'}</td>
                                                        <td className="px-3 py-2 text-mist text-xs hidden lg:table-cell max-w-[150px] truncate">{user.institution || '-'}</td>
                                                        <td className="px-3 py-2 text-center">
                                                            <button
                                                                onClick={() => handleViewDocs(user.id, user.username)}
                                                                className="text-teal font-bold text-xs hover:underline cursor-pointer"
                                                                title="View documents"
                                                            >
                                                                {user.documents_generated || 0}
                                                            </button>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            <span className="text-purple-400 font-bold text-xs">{user.ai_requests_count || 0}</span>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            <span className="text-white text-xs">{user.pages_this_month || 0}/300</span>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            <span className="text-teal font-bold text-xs">{user.pages_balance || 0}</span>
                                                        </td>
                                                        <td className="px-3 py-2 text-mist text-xs hidden md:table-cell">{formatDate(user.created_at)}</td>
                                                        <td className="px-3 py-2 text-center">
                                                            <div className="flex items-center justify-center gap-1">
                                                                <button
                                                                    onClick={() => setExpandedUserId(expandedUserId === user.id ? null : user.id)}
                                                                    className="p-1 text-mist hover:text-teal transition-colors"
                                                                    title="View details"
                                                                >
                                                                    <Icons.Eye size={14} />
                                                                </button>
                                                                {!user.is_admin && (
                                                                    <button 
                                                                        onClick={() => handleDeleteUser(user.id, user.username)}
                                                                        className="p-1 text-mist hover:text-red-400 transition-colors"
                                                                        title="Delete user"
                                                                    >
                                                                        <Icons.Trash size={14} />
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>

                                        {sortedUserList.length === 0 && (
                                            <div className="text-center py-8 text-mist">
                                                No users found matching your search.
                                            </div>
                                        )}
                                    </div>

                                    {/* User Details Modal */}
                                    {expandedUserId && (() => {
                                        const user = userList.find(u => u.id === expandedUserId);
                                        if (!user) return null;
                                        return (
                                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setExpandedUserId(null)}>
                                                <div className="bg-[#0a1929] border border-teal/20 rounded-xl max-w-lg w-full p-4 shadow-2xl" onClick={e => e.stopPropagation()}>
                                                    <div className="flex items-center justify-between mb-4">
                                                        <h3 className="text-white font-bold flex items-center gap-2">
                                                            <div className="w-8 h-8 bg-gradient-to-r from-[#1E5A8E] to-teal rounded-full flex items-center justify-center text-white text-sm font-bold">
                                                                {user.username?.charAt(0).toUpperCase()}
                                                            </div>
                                                            {user.username}
                                                        </h3>
                                                        <button onClick={() => setExpandedUserId(null)} className="text-mist hover:text-white">
                                                            <Icons.X size={18} />
                                                        </button>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-3 text-xs">
                                                        <div><span className="text-mist">Email:</span> <span className="text-white">{user.email || '-'}</span></div>
                                                        <div><span className="text-mist">Institution:</span> <span className="text-white">{user.institution || '-'}</span></div>
                                                        <div><span className="text-mist">Contact:</span> <span className="text-white">{user.contact || '-'}</span></div>
                                                        <div><span className="text-mist">Plan:</span> <span className={user.plan === 'free' ? 'text-mist' : 'text-teal'}>{user.plan?.toUpperCase()}</span></div>
                                                        <div><span className="text-mist">Joined:</span> <span className="text-white">{formatDate(user.created_at)}</span></div>
                                                        <div><span className="text-mist">Last Activity:</span> <span className="text-white">{formatDate(user.last_activity)}</span></div>
                                                        <div><span className="text-mist">Documents:</span> <span className="text-teal font-bold">{user.documents_generated || 0}</span></div>
                                                        <div><span className="text-mist">AI Requests:</span> <span className="text-purple-400 font-bold">{user.ai_requests_count || 0}</span></div>
                                                        <div><span className="text-mist">Pages Used:</span> <span className="text-white">{user.pages_this_month || 0}/300</span></div>
                                                        <div><span className="text-mist">Paid Balance:</span> <span className="text-teal font-bold">{user.pages_balance || 0}</span></div>
                                                        <div><span className="text-mist">Referral Code:</span> <span className="text-white font-mono">{user.referral_code || '-'}</span></div>
                                                        <div><span className="text-mist">Referred By:</span> <span className="text-white">{user.referred_by || '-'}</span></div>
                                                    </div>
                                                    {user.documents && user.documents.length > 0 && (
                                                        <div className="mt-4">
                                                            <div className="text-mist text-xs mb-2">Recent Documents</div>
                                                            <div className="flex flex-wrap gap-1">
                                                                {user.documents.slice(0, 5).map(doc => (
                                                                    <button
                                                                        key={doc.id}
                                                                        onClick={() => handleDownloadDocument(doc.job_id, doc.filename)}
                                                                        className="px-2 py-1 bg-white/5 hover:bg-teal/20 rounded text-[10px] text-white flex items-center gap-1 transition-colors"
                                                                    >
                                                                        <Icons.Download size={10} />
                                                                        <span className="max-w-[80px] truncate">{doc.filename}</span>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                                )}

                                {/* Documents Tab Content - Table Format */}
                                {adminTab === 'documents' && (
                                <div className="p-2 md:p-4">
                                    {loadingDocuments ? (
                                        <div className="flex items-center justify-center py-12">
                                            <div className="lightning-loading">
                                                <Icons.Zap />
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto max-h-[60vh] overflow-y-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-white/5 sticky top-0">
                                                    <tr className="text-left text-mist text-xs">
                                                        <th className="px-3 py-2 font-medium">#</th>
                                                        <th className="px-3 py-2 font-medium">Filename</th>
                                                        <th className="px-3 py-2 font-medium hidden md:table-cell">Original</th>
                                                        <th className="px-3 py-2 font-medium">User</th>
                                                        <th className="px-3 py-2 font-medium hidden lg:table-cell">Institution</th>
                                                        <th className="px-3 py-2 font-medium">Created</th>
                                                        <th className="px-3 py-2 font-medium text-center">Download</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-white/5">
                                                    {allDocuments.filter(doc => 
                                                        doc.filename?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                                                        doc.user?.username?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                                                        doc.original_filename?.toLowerCase().includes(adminSearch.toLowerCase())
                                                    ).map((doc, idx) => (
                                                        <tr key={doc.id} className="hover:bg-white/5 transition-colors">
                                                            <td className="px-3 py-2 text-mist text-xs">{idx + 1}</td>
                                                            <td className="px-3 py-2">
                                                                <div className="flex items-center gap-2">
                                                                    <Icons.FileText size={14} className="text-teal" />
                                                                    <span className="text-white text-xs max-w-[200px] truncate">{doc.filename}</span>
                                                                </div>
                                                            </td>
                                                            <td className="px-3 py-2 text-mist text-xs hidden md:table-cell max-w-[150px] truncate">{doc.original_filename || '-'}</td>
                                                            <td className="px-3 py-2">
                                                                <div className="flex items-center gap-2">
                                                                    <div className="w-6 h-6 bg-gradient-to-r from-[#1E5A8E] to-teal rounded-full flex items-center justify-center text-white text-[10px] font-bold">
                                                                        {doc.user?.username?.charAt(0).toUpperCase() || '?'}
                                                                    </div>
                                                                    <span className="text-white text-xs">{doc.user?.username || 'Unknown'}</span>
                                                                </div>
                                                            </td>
                                                            <td className="px-3 py-2 text-mist text-xs hidden lg:table-cell max-w-[150px] truncate">{doc.user?.institution || '-'}</td>
                                                            <td className="px-3 py-2 text-mist text-xs">{formatDate(doc.created_at)}</td>
                                                            <td className="px-3 py-2 text-center">
                                                                <button
                                                                    onClick={() => handleDownloadDocument(doc.job_id, doc.filename)}
                                                                    className="p-1.5 bg-teal/20 hover:bg-teal/30 text-teal rounded transition-colors"
                                                                    title="Download document"
                                                                >
                                                                    <Icons.Download size={14} />
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>

                                            {allDocuments.length === 0 && (
                                                <div className="text-center py-8 text-mist">
                                                    No documents found.
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                )}

                                {/* Institution Requests Tab Content - Table Format */}
                                {adminTab === 'requests' && (
                                <div className="p-2 md:p-4">
                                    <div className="overflow-x-auto max-h-[60vh] overflow-y-auto">
                                        <table className="w-full text-sm">
                                            <thead className="bg-white/5 sticky top-0">
                                                <tr className="text-left text-mist text-xs">
                                                    <th className="px-3 py-2 font-medium">#</th>
                                                    <th className="px-3 py-2 font-medium">Institution</th>
                                                    <th className="px-3 py-2 font-medium hidden md:table-cell">Requested By</th>
                                                    <th className="px-3 py-2 font-medium">Date</th>
                                                    <th className="px-3 py-2 font-medium text-center">Status</th>
                                                    <th className="px-3 py-2 font-medium text-center">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-white/5">
                                                {institutionRequests.filter(req => 
                                                    req.institution_name?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                                                    req.user?.username?.toLowerCase().includes(adminSearch.toLowerCase())
                                                ).map((request, idx) => (
                                                    <tr key={request.id} className="hover:bg-white/5 transition-colors">
                                                        <td className="px-3 py-2 text-mist text-xs">{idx + 1}</td>
                                                        <td className="px-3 py-2">
                                                            <div className="flex items-center gap-2">
                                                                <Icons.Book size={14} className="text-amber" />
                                                                <span className="text-white text-xs font-medium">{request.institution_name}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-3 py-2 hidden md:table-cell">
                                                            <div className="flex items-center gap-2">
                                                                <div className="w-5 h-5 bg-gradient-to-r from-[#1E5A8E] to-teal rounded-full flex items-center justify-center text-white text-[8px] font-bold">
                                                                    {request.user?.username?.charAt(0).toUpperCase() || '?'}
                                                                </div>
                                                                <span className="text-mist text-xs">{request.user?.username || 'Guest'}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-3 py-2 text-mist text-xs">{formatDate(request.created_at)}</td>
                                                        <td className="px-3 py-2 text-center">
                                                            <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${
                                                                request.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400' :
                                                                request.status === 'completed' ? 'bg-green-500/20 text-green-400' :
                                                                'bg-red-500/20 text-red-400'
                                                            }`}>
                                                                {request.status?.charAt(0).toUpperCase() + request.status?.slice(1)}
                                                            </span>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            {request.status === 'pending' && (
                                                                <div className="flex items-center justify-center gap-1">
                                                                    <button 
                                                                        onClick={() => alert('Mark as completed: ' + request.institution_name)}
                                                                        className="p-1 text-green-400 hover:bg-green-500/20 rounded transition-colors"
                                                                        title="Mark Completed"
                                                                    >
                                                                        <Icons.Check size={14} />
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => alert('Reject: ' + request.institution_name)}
                                                                        className="p-1 text-red-400 hover:bg-red-500/20 rounded transition-colors"
                                                                        title="Reject"
                                                                    >
                                                                        <Icons.X size={14} />
                                                                    </button>
                                                                </div>
                                                            )}
                                                            {request.status !== 'pending' && (
                                                                <span className="text-mist text-xs">-</span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>

                                        {institutionRequests.length === 0 && (
                                            <div className="text-center py-8 text-mist">
                                                No institution requests yet.
                                            </div>
                                        )}
                                    </div>}
                                </div>
                                )}

                                {/* Support Tab Content */}
                                {adminTab === 'support' && (
                                <div className="p-2 md:p-4">
                                    {loadingSupportRequests ? (
                                        <div className="flex items-center justify-center py-8">
                                            <Icons.Loader className="animate-spin text-teal" size={24} />
                                        </div>
                                    ) : (
                                        <div className="overflow-x-auto max-h-[60vh] overflow-y-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-white/5 sticky top-0">
                                                    <tr className="text-left text-mist text-xs">
                                                        <th className="px-3 py-2 font-medium">#</th>
                                                        <th className="px-3 py-2 font-medium">Subject</th>
                                                        <th className="px-3 py-2 font-medium hidden md:table-cell">Requester</th>
                                                        <th className="px-3 py-2 font-medium hidden lg:table-cell">User</th>
                                                        <th className="px-3 py-2 font-medium">Date</th>
                                                        <th className="px-3 py-2 font-medium text-center">Status</th>
                                                        <th className="px-3 py-2 font-medium text-center">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-white/5">
                                                    {supportRequests.filter(req =>
                                                        req.name?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                                                        req.email?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                                                        req.subject?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                                                        req.message?.toLowerCase().includes(adminSearch.toLowerCase()) ||
                                                        req.user?.username?.toLowerCase().includes(adminSearch.toLowerCase())
                                                    ).map((request, idx) => (
                                                        <tr key={request.id} className="hover:bg-white/5 transition-colors">
                                                            <td className="px-3 py-2 text-mist text-xs">{idx + 1}</td>
                                                            <td className="px-3 py-2">
                                                                <div className="text-white text-xs font-medium">{request.subject || 'Support request'}</div>
                                                                <div className="text-mist text-[10px] max-w-[260px] truncate">{request.message}</div>
                                                            </td>
                                                            <td className="px-3 py-2 text-mist text-xs hidden md:table-cell">
                                                                <div className="text-white text-xs">{request.name}</div>
                                                                <div className="text-mist text-[10px]">{request.email}</div>
                                                            </td>
                                                            <td className="px-3 py-2 text-mist text-xs hidden lg:table-cell">
                                                                {request.user ? (
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="w-5 h-5 bg-gradient-to-r from-[#1E5A8E] to-teal rounded-full flex items-center justify-center text-white text-[8px] font-bold">
                                                                            {request.user.username?.charAt(0).toUpperCase()}
                                                                        </div>
                                                                        <span className="text-white text-xs">{request.user.username}</span>
                                                                    </div>
                                                                ) : (
                                                                    <span className="text-mist text-xs">Guest</span>
                                                                )}
                                                            </td>
                                                            <td className="px-3 py-2 text-mist text-xs">{formatDate(request.created_at)}</td>
                                                            <td className="px-3 py-2 text-center">
                                                                <span className={`px-2 py-0.5 rounded text-[10px] font-medium ${
                                                                    request.status === 'resolved' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'
                                                                }`}>
                                                                    {request.status?.charAt(0).toUpperCase() + request.status?.slice(1)}
                                                                </span>
                                                            </td>
                                                            <td className="px-3 py-2 text-center">
                                                                {request.status === 'resolved' ? (
                                                                    <button
                                                                        onClick={() => updateSupportRequestStatus(request.id, 'open')}
                                                                        className="p-1 text-yellow-400 hover:bg-yellow-500/20 rounded transition-colors"
                                                                        title="Reopen"
                                                                    >
                                                                        <Icons.RefreshCw size={14} />
                                                                    </button>
                                                                ) : (
                                                                    <button
                                                                        onClick={() => updateSupportRequestStatus(request.id, 'resolved')}
                                                                        className="p-1 text-green-400 hover:bg-green-500/20 rounded transition-colors"
                                                                        title="Mark resolved"
                                                                    >
                                                                        <Icons.Check size={14} />
                                                                    </button>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>

                                            {supportRequests.length === 0 && (
                                                <div className="text-center py-8 text-mist">
                                                    No support requests yet.
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                )}

                                {/* Referrals Tab Content */}
                                {adminTab === 'referrals' && (
                                <div className="p-2 md:p-4">
                                    <div className="overflow-x-auto max-h-[60vh] overflow-y-auto">
                                        <table className="w-full text-sm">
                                            <thead className="bg-white/5 sticky top-0">
                                                <tr className="text-left text-mist text-xs">
                                                    <th className="px-3 py-2 font-medium">User</th>
                                                    <th className="px-3 py-2 font-medium">Referral Code</th>
                                                    <th className="px-3 py-2 font-medium">Referred By</th>
                                                    <th className="px-3 py-2 font-medium text-center">Referrals Made</th>
                                                    <th className="px-3 py-2 font-medium">Joined</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-white/5">
                                                {userList.filter(u => u.referral_code || u.referred_by).map(user => (
                                                    <tr key={user.id} className="hover:bg-white/5 transition-colors">
                                                        <td className="px-3 py-2">
                                                            <div className="flex items-center gap-2">
                                                                <div className="w-7 h-7 bg-gradient-to-r from-[#1E5A8E] to-teal rounded-full flex items-center justify-center text-white text-xs font-bold">
                                                                    {user.username?.charAt(0).toUpperCase()}
                                                                </div>
                                                                <span className="text-white text-xs">{user.username}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <span className="text-teal font-mono text-xs">{user.referral_code || '-'}</span>
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            <span className="text-mist text-xs">{user.referred_by || '-'}</span>
                                                        </td>
                                                        <td className="px-3 py-2 text-center">
                                                            <span className="text-purple-400 font-bold text-xs">
                                                                {userList.filter(u => u.referred_by === user.referral_code).length}
                                                            </span>
                                                        </td>
                                                        <td className="px-3 py-2 text-mist text-xs">{formatDate(user.created_at)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>

                                        {userList.filter(u => u.referral_code || u.referred_by).length === 0 && (
                                            <div className="text-center py-8 text-mist">
                                                No referral data yet.
                                            </div>
                                        )}
                                    </div>
                                </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* User Documents Modal */}
                    {selectedUserDocs && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="glass-card rounded-xl w-full max-w-2xl max-h-[80vh] overflow-hidden shadow-xl m-4">
                                <div className="flex justify-between items-center p-4 border-b border-white/10">
                                    <h3 className="text-white font-bold">{selectedUserDocs.username}'s Documents</h3>
                                    <button onClick={() => setSelectedUserDocs(null)} className="text-mist hover:text-white">
                                        <Icons.X size={20} />
                                    </button>
                                </div>
                                <div className="p-4 overflow-y-auto max-h-[60vh]">
                                    {loadingDocs ? (
                                        <div className="flex items-center justify-center py-8">
                                            <Icons.Loader className="animate-spin text-teal" size={24} />
                                        </div>
                                    ) : selectedUserDocs.docs && selectedUserDocs.docs.length > 0 ? (
                                        <div className="space-y-2">
                                            {selectedUserDocs.docs.map((doc, i) => (
                                                <div key={i} className="flex items-center justify-between p-3 bg-white/5 rounded-lg hover:bg-white/10 transition-colors">
                                                    <div className="flex items-center gap-3">
                                                        <Icons.FileText className="text-teal" size={20} />
                                                        <div>
                                                            <p className="text-white text-sm">{doc.filename || doc.original_filename || 'Untitled'}</p>
                                                            <p className="text-mist text-xs">{formatDate(doc.created_at)}</p>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        {doc.job_id && (
                                                            <a
                                                                href={`${API_BASE}/download/${doc.job_id}`}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="flex items-center gap-1 px-3 py-1.5 bg-teal/20 text-teal rounded-lg hover:bg-teal/30 transition-colors text-xs"
                                                            >
                                                                <Icons.Download size={14} />
                                                                Download
                                                            </a>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 text-mist">
                                            No documents found for this user.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Render the application
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PatternDocFormatter />);
    </script>
</body>
</html>
